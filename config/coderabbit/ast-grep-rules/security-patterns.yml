# Security Pattern Rules
# Enforces security best practices from .github/SECURITY.md

---
# Rule: Detect missing input validation before database queries
id: missing-input-validation
language: typescript
rule:
  all:
    - pattern: $SUPABASE.$METHOD($$$)
      kind: call_expression
      has:
        kind: member_expression
        regex: supabase\.(from|rpc)
    - not:
        precedes:
          pattern: z\.object($$$)
          kind: call_expression
message: "Database queries should validate input with Zod schemas before execution. Add input validation using z.object() from zod"
severity: error

---
# Rule: Detect direct user input in URL construction
id: unsafe-url-construction
language: typescript
rule:
  all:
    - pattern: new URL($INPUT, $BASE)
      kind: new_expression
    - has:
        kind: identifier
        regex: user|input|param|query|body
message: "URL construction with user input must be validated/sanitized. Use URL validation or sanitization before constructing URLs"
severity: error

---
# Rule: Detect missing auth checks in API routes
id: missing-auth-in-api-route
language: typescript
rule:
  all:
    - pattern: export async function $METHOD($REQ: NextRequest) { $$$ }
      kind: function_declaration
    - inside:
        pattern: app/api/**/*.ts
    - not:
        has:
          pattern: (getUser|checkAuth|verifyToken)($$$)
message: "API routes must include authentication checks. Use getUser() or checkAuth() before processing requests"
severity: error

---
# Rule: Detect missing auth checks in server actions
id: missing-auth-in-server-action
language: typescript
rule:
  all:
    - pattern: 'use server'
    - has:
        pattern: export (const|function) $ACTION($$$) { $$$ }
    - not:
        has:
          pattern: (authedAction|optionalAuthAction|rateLimitedAction|actionClient)($$$)
message: "Server actions must use safe-action middleware (authedAction, optionalAuthAction, rateLimitedAction, or actionClient) for authentication. Import from @heyclaude/web-runtime/actions/safe-action"
severity: error

---
# Rule: Detect PII logging in log context (outside logger.child) without hashing
id: pii-logging-without-hash
language: typescript
rule:
  all:
    - pattern: ($LOGGER|logger).$METHOD($$$, { $CONTEXT })
      kind: call_expression
    - has:
        pattern: (userId|user_id|email|phone|ssn): $VALUE
          regex: userId|user_id|email|phone|ssn
    - not:
        inside:
          pattern: logger.child({ $$$ })
    - not:
        has:
          pattern: (hashUserId|hashEmail|hashPII)($$$)
message: "PII (userId, email, etc.) in log context must be hashed. Use hashUserId() or hashEmail() from @heyclaude/shared-runtime/privacy. NOTE: logger.child({ userId }) automatically hashes via redaction - use that pattern instead."
severity: warning

---
# Rule: Detect dangerous eval() or Function() usage
id: dangerous-eval-usage
language: typescript
rule:
  any:
    - pattern: eval($$$)
      kind: call_expression
    - pattern: new Function($$$)
      kind: new_expression
message: "eval() and Function() are dangerous and should be avoided. Use safer alternatives like JSON.parse() or schema validation"
severity: error

---
# Rule: Detect unsanitized user input in dangerouslySetInnerHTML
id: unsafe-inner-html
language: typescript
rule:
  all:
    - pattern: dangerouslySetInnerHTML={{ __html: $INPUT }}
      kind: jsx_attribute
    - has:
        kind: identifier
        regex: user|input|param|query|body
message: "User input in dangerouslySetInnerHTML must be sanitized. Use DOMPurify or similar sanitization library"
severity: error

---
# Rule: Detect missing CORS headers in API routes
id: missing-cors-headers
language: typescript
rule:
  all:
    - pattern: export async function $METHOD($REQ: NextRequest) { $$$ return NextResponse.$METHOD($$$) }
      kind: function_declaration
    - inside:
        pattern: app/api/**/*.ts
    - not:
        has:
          pattern: (Access-Control|CORS|cors)($$$)
message: "API routes should include proper CORS headers. Use CORS middleware or set Access-Control-Allow-Origin headers"
severity: warning

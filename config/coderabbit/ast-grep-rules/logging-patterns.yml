# Logging Pattern Rules
# Enforces logging standards from .cursor/rules/logging-instrumentation.mdc
# Updated to match current logging architecture: packages/shared-runtime/src/logger/index.ts
# Matches: config/tools/eslint-plugin-architectural-rules.js -> require-logging-context, require-section-logging
# NOTE: requestId was removed from codebase - do NOT check for it

---
# Rule: Detect console.* usage (should use logger instead)
id: no-console-usage
language: typescript
rule:
  pattern: console.$METHOD($$$)
  kind: call_expression
  has:
    kind: member_expression
    pattern: console.$METHOD
message: "Use structured logging (logger.*) instead of console.*. Import logger from @heyclaude/web-runtime/logging/server (server) or @heyclaude/web-runtime/logging/client (client)"
severity: error
fix: |
  // Replace console.$METHOD with appropriate logger method
  // Server: logger.info/warn/error from @heyclaude/web-runtime/logging/server
  // Client: logClientInfo/logClientWarn/logClientError from @heyclaude/web-runtime/logging/client

---
# Rule: Detect missing normalizeError in catch blocks
id: missing-normalize-error
language: typescript
rule:
  all:
    - pattern: catch ($ERROR) { $$$ }
      kind: catch_clause
    - not:
        has:
          pattern: normalizeError($$$)
message: "Catch blocks must use normalizeError() before logging or throwing. Import normalizeError from @heyclaude/web-runtime/logging/server (server) or @heyclaude/shared-runtime/logger (shared)"
severity: error

---
# Rule: Detect missing logger.child() for request-scoped context in server components
id: missing-logger-child-context
language: typescript
rule:
  all:
    - pattern: export default async function $NAME($$$) { $$$ }
      kind: function_declaration
    - inside:
        pattern: app/**/*.tsx
    - has:
        pattern: logger.$METHOD($$$)
    - not:
        has:
          pattern: const $LOGGER = logger.child({ operation: $OP, route: $ROUTE, module: $MODULE })
message: "Server components/pages must use logger.child({ operation, route, module }) for request-scoped context. Create: const reqLogger = logger.child({ operation: 'PageName', route: '/path', module: 'apps/web/src/app/path' }) and use reqLogger for all logs. NOTE: requestId was removed from codebase - do NOT add it."
severity: error

---
# Rule: Detect missing operation/route/module in logger.child() calls
id: missing-operation-route-module-in-child
language: typescript
rule:
  all:
    - pattern: logger.child({ $$$ })
      kind: call_expression
    - not:
        has:
          pattern: operation: $OP
    - not:
        has:
          pattern: route: $ROUTE
    - not:
        has:
          pattern: module: $MODULE
message: "logger.child() must include operation, route, and module fields. Use: logger.child({ operation: 'PageName', route: '/path', module: 'apps/web/src/app/path' })"
severity: error

---
# Rule: Detect missing section-based logging in server pages
id: missing-section-logging
language: typescript
rule:
  all:
    - pattern: export default async function $NAME($$$) { $$$ }
      kind: function_declaration
    - inside:
        pattern: app/**/*.tsx
    - has:
        pattern: $LOGGER.$METHOD($$$)
    - not:
        has:
          pattern: section: $SECTION
message: "Server pages should use section-based logging with section: 'section-name' in log context. Example: reqLogger.info({ section: 'data-fetch' }, 'message') or reqLogger.info('message', { section: 'data-fetch' })"
severity: error

---
# Rule: Detect missing useLoggedAsync in client async operations
id: missing-use-logged-async
language: typescript
rule:
  all:
    - pattern: const $HANDLER = async () => { $$$ }
      kind: variable_declarator
    - inside:
        pattern: 'use client'
    - not:
        has:
          pattern: useLoggedAsync($$$)
message: "Client components with async operations must use useLoggedAsync hook. Import useLoggedAsync from @heyclaude/web-runtime/hooks"
severity: warning

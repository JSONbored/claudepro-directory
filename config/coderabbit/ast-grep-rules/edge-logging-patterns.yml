# Edge Function Logging Pattern Rules
# Enforces edge function logging standards from ESLint rule: require-edge-logging-setup
# Matches: config/tools/eslint-plugin-architectural-rules.js -> require-edge-logging-setup

---
# Rule: Detect wrong logger import in edge functions (should use shared-runtime or edge-runtime)
id: wrong-logger-import-edge
language: typescript
rule:
  all:
    - pattern: import $ITEMS from '@heyclaude/web-runtime/$MODULE'
      kind: import_statement
      has:
        regex: (core|logging/server)
    - inside:
        pattern: apps/edge/supabase/functions/**/*.ts
message: "Edge functions must use logError/logInfo/logWarn from @heyclaude/shared-runtime/logging.ts OR logger/initRequestLogging from @heyclaude/edge-runtime/utils/logger-helpers.ts. Do not use logger from @heyclaude/web-runtime/core or @heyclaude/web-runtime/logging/server."
severity: error

---
# Rule: Detect missing logContext creation in edge function handlers
id: missing-log-context-edge
language: typescript
rule:
  all:
    - pattern: export (const|function) $HANDLER($$$) { $$$ }
      kind: function_declaration
      regex: (GET|POST|PUT|DELETE|PATCH|OPTIONS|HEAD)
    - inside:
        pattern: apps/edge/supabase/functions/**/*.ts
    - not:
        has:
          pattern: const logContext = create$CONTEXT($$$)
          regex: (createEmailHandlerContext|createDataApiContext|createSearchContext|createTransformApiContext|createUtilityContext|createNotificationRouterContext|createChangelogHandlerContext|createWebAppContext)
message: "Edge function handler is missing logContext creation. Add: const logContext = create{Service}Context(...) at handler start."
severity: error

---
# Rule: Detect missing initRequestLogging() call in edge function handlers
id: missing-init-request-logging
language: typescript
rule:
  all:
    - pattern: export (const|function) $HANDLER($$$) { $$$ }
      kind: function_declaration
      regex: (GET|POST|PUT|DELETE|PATCH|OPTIONS|HEAD)
    - inside:
        pattern: apps/edge/supabase/functions/**/*.ts
    - has:
        pattern: const logContext = create$CONTEXT($$$)
    - not:
        has:
          pattern: initRequestLogging($$$)
message: "Edge function handler is missing initRequestLogging() call. Add: initRequestLogging(logContext) at handler start. This will automatically set logger bindings."
severity: error

---
# Rule: Detect missing traceRequestComplete() call before success response
id: missing-trace-request-complete
language: typescript
rule:
  all:
    - pattern: export (const|function) $HANDLER($$$) { $$$ }
      kind: function_declaration
      regex: (GET|POST|PUT|DELETE|PATCH|OPTIONS|HEAD)
    - inside:
        pattern: apps/edge/supabase/functions/**/*.ts
    - has:
        pattern: return (new Response|Response.$METHOD)($$$)
    - not:
        has:
          pattern: traceRequestComplete($$$)
message: "Edge function handler is missing traceRequestComplete() call before success response. Add: traceRequestComplete(logContext) before returning."
severity: error

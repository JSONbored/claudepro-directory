# Cache Components Pattern Rules
# Enforces Cache Components patterns from ESLint rule: require-cache-components
# Matches: config/tools/eslint-plugin-architectural-rules.js -> require-cache-components

---
# Rule: Detect missing 'use cache' directive in server components with async data fetching
id: missing-use-cache-directive
language: typescript
rule:
  all:
    - pattern: export default async function $COMPONENT($$$) { $$$ }
      kind: function_declaration
    - inside:
        pattern: app/**/*.tsx
    - has:
        pattern: await $ASYNC($$$)
    - not:
        precedes:
          pattern: 'use cache'
message: "Server components with async data fetching must use 'use cache' or 'use cache: private' directive. Add directive as first statement in function body."
severity: error

---
# Rule: Detect non-deterministic operations before connection()
id: non-deterministic-before-connection
language: typescript
rule:
  all:
    - pattern: export default async function $COMPONENT($$$) { $$$ }
      kind: function_declaration
    - inside:
        pattern: app/**/*.tsx
    - has:
        pattern: (Date.now()|Math.random()|new Date()|performance.now()|crypto.randomUUID())($$$)
    - not:
        follows:
          pattern: await connection()
message: "Non-deterministic operations (Date.now(), Math.random(), new Date(), performance.now(), crypto.randomUUID()) must come after await connection(). Move operation after connection() call."
severity: error

---
# Rule: Detect missing connection() in components with non-deterministic operations
id: missing-connection-with-non-deterministic
language: typescript
rule:
  all:
    - pattern: export default async function $COMPONENT($$$) { $$$ }
      kind: function_declaration
    - inside:
        pattern: app/**/*.tsx
    - has:
        pattern: (Date.now()|Math.random()|new Date()|performance.now()|crypto.randomUUID())($$$)
    - not:
        has:
          pattern: await connection()
message: "Components using non-deterministic operations must call await connection() at the start. Add: await connection() at function start."
severity: error

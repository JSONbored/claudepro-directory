{
  "slug": "rust-cargo-check",
  "description": "Automatically runs cargo check and clippy when Rust files are modified",
  "category": "hooks",
  "author": "JSONbored",
  "dateAdded": "2025-09-19",
  "tags": ["rust", "cargo", "clippy", "linting", "compilation"],
  "hookType": "PostToolUse",
  "features": [
    "Fast compilation checking with cargo check",
    "Code linting with clippy",
    "Rust best practices enforcement",
    "Dependency validation",
    "Performance optimization suggestions",
    "Security vulnerability detection"
  ],
  "useCases": [
    "Validate Rust code compilation before commits",
    "Catch common Rust programming errors early",
    "Enforce Rust coding standards with clippy",
    "Check dependency compatibility",
    "Identify performance improvement opportunities",
    "Ensure code follows Rust best practices",
    "Run security analysis on Rust code",
    "Validate Cargo.toml configuration changes"
  ],
  "configuration": {
    "hookConfig": {
      "hooks": {
        "postToolUse": {
          "script": "./.claude/hooks/rust-cargo-check.sh",
          "matchers": ["write", "edit"]
        }
      }
    },
    "scriptContent": "#!/bin/bash\n\n# Read the tool input from stdin\nINPUT=$(cat)\nTOOL_NAME=$(echo \"$INPUT\" | jq -r '.tool_name')\nFILE_PATH=$(echo \"$INPUT\" | jq -r '.tool_input.file_path // .tool_input.path // \"\"')\n\nif [ -z \"$FILE_PATH\" ]; then\n  exit 0\nfi\n\n# Check if this is a Rust file or Cargo configuration\nif [[ \"$FILE_PATH\" == *.rs ]] || [[ \"$FILE_PATH\" == *Cargo.toml ]] || [[ \"$FILE_PATH\" == *Cargo.lock ]]; then\n    echo \"ðŸ¦€ Rust Cargo Check - Analyzing Rust code...\"\n    echo \"ðŸ“„ File: $FILE_PATH\"\n    \n    # Check if cargo is available\n    if ! command -v cargo >/dev/null 2>&1; then\n        echo \"âš ï¸ Cargo not found - please install Rust toolchain\"\n        echo \"ðŸ’¡ Install from: https://rustup.rs/\"\n        exit 1\n    fi\n    \n    # Check if we're in a Rust project\n    if [ ! -f \"Cargo.toml\" ]; then\n        echo \"âš ï¸ No Cargo.toml found - not a Rust project\"\n        exit 0\n    fi\n    \n    echo \"ðŸ” Running Rust toolchain checks...\"\n    \n    # Step 1: Run cargo check for fast compilation validation\n    echo \"âš¡ Running cargo check (fast compilation check)...\"\n    if cargo check --message-format=short; then\n        echo \"âœ… Cargo check passed - code compiles successfully\"\n    else\n        echo \"âŒ Cargo check failed - compilation errors found\"\n        echo \"ðŸ’¡ Fix compilation errors before proceeding\"\n        exit 1\n    fi\n    \n    # Step 2: Run clippy for linting (if available)\n    echo \"\"\n    echo \"ðŸ“‹ Running clippy (Rust linter)...\"\n    if command -v cargo-clippy >/dev/null 2>&1 || cargo clippy --version >/dev/null 2>&1; then\n        if cargo clippy --message-format=short -- -W clippy::pedantic -W clippy::nursery; then\n            echo \"âœ… Clippy analysis passed - no linting issues\"\n        else\n            echo \"âš ï¸ Clippy found linting issues (non-blocking)\"\n        fi\n    else\n        echo \"â„¹ï¸ Clippy not available - install with: rustup component add clippy\"\n    fi\n    \n    # Step 3: Check formatting (if rustfmt is available)\n    echo \"\"\n    echo \"ðŸŽ¨ Checking code formatting...\"\n    if command -v rustfmt >/dev/null 2>&1; then\n        if cargo fmt -- --check; then\n            echo \"âœ… Code formatting is correct\"\n        else\n            echo \"âš ï¸ Code formatting issues found\"\n            echo \"ðŸ’¡ Run 'cargo fmt' to fix formatting\"\n        fi\n    else\n        echo \"â„¹ï¸ rustfmt not available - install with: rustup component add rustfmt\"\n    fi\n    \n    # Step 4: Security audit (if cargo-audit is available)\n    echo \"\"\n    echo \"ðŸ”’ Running security audit...\"\n    if command -v cargo-audit >/dev/null 2>&1; then\n        if cargo audit; then\n            echo \"âœ… No known security vulnerabilities found\"\n        else\n            echo \"âš ï¸ Security vulnerabilities detected - review dependencies\"\n        fi\n    else\n        echo \"â„¹ï¸ cargo-audit not available - install with: cargo install cargo-audit\"\n    fi\n    \n    # Step 5: Project analysis\n    echo \"\"\n    echo \"ðŸ“Š Project Analysis:\"\n    \n    # Count Rust files\n    RUST_FILES=$(find . -name \"*.rs\" -not -path \"./target/*\" | wc -l)\n    echo \"  â€¢ Rust files: $RUST_FILES\"\n    \n    # Check for tests\n    TEST_FILES=$(find . -name \"*.rs\" -not -path \"./target/*\" -exec grep -l \"#\\[test\\]\\|#\\[cfg(test)\\]\" {} \\; | wc -l)\n    echo \"  â€¢ Files with tests: $TEST_FILES\"\n    \n    # Check dependencies\n    DEPENDENCIES=$(grep -c '^[a-zA-Z].*=' Cargo.toml 2>/dev/null || echo 0)\n    echo \"  â€¢ Dependencies: $DEPENDENCIES\"\n    \n    # Check for unsafe blocks\n    if find . -name \"*.rs\" -not -path \"./target/*\" -exec grep -l \"unsafe\" {} \\; | head -1 >/dev/null 2>&1; then\n        UNSAFE_COUNT=$(find . -name \"*.rs\" -not -path \"./target/*\" -exec grep -c \"unsafe\" {} \\; | awk '{sum+=$1} END {print sum}')\n        echo \"  â€¢ âš ï¸ Unsafe blocks found: $UNSAFE_COUNT\"\n    fi\n    \n    echo \"\"\n    echo \"ðŸ’¡ Rust Development Tips:\"\n    echo \"  â€¢ Use 'cargo test' to run all tests\"\n    echo \"  â€¢ Use 'cargo build --release' for optimized builds\"\n    echo \"  â€¢ Use 'cargo doc --open' to generate and view documentation\"\n    echo \"  â€¢ Use 'cargo bench' for benchmarking (if available)\"\n    echo \"  â€¢ Consider using 'cargo watch' for continuous testing\"\n    \n    echo \"\"\n    echo \"ðŸŽ¯ Rust code analysis complete!\"\n    \nelse\n    echo \"â„¹ï¸ File is not a Rust file: $FILE_PATH\"\nfi\n\nexit 0"
  },
  "troubleshooting": [
    {
      "issue": "Cargo check fails with 'No Cargo.toml found' in monorepos",
      "solution": "Hook searches from file directory upward but may fail in nested workspaces. Add cd logic to find workspace root: while [ ! -f Cargo.toml ] && [ $(pwd) != / ]; do cd ..; done before running cargo commands."
    },
    {
      "issue": "Target directory compilation artifacts cause slow check times",
      "solution": "Cargo check reuses incremental compilation from target/. Ensure .gitignore excludes target/ but preserve it locally. Use cargo clean selectively or CARGO_TARGET_DIR to separate hook builds from development builds."
    },
    {
      "issue": "Cargo audit fails when offline or network restricted environments",
      "solution": "Script treats cargo-audit as optional but doesn't handle network errors. Add CARGO_NET_OFFLINE=true check or wrap in: timeout 5s cargo audit || echo 'Audit skipped (offline)' to prevent hanging on network unavailable."
    },
    {
      "issue": "Multiple Rust files changed simultaneously trigger concurrent checks",
      "solution": "PostToolUse fires per operation causing parallel cargo check processes. Add flock-based locking: { flock -n 200 || exit 0; cargo check; } 200>/tmp/cargo-check.lock to serialize executions and prevent resource contention."
    },
    {
      "issue": "Hook executes before file write completes showing stale errors",
      "solution": "PostToolUse hooks fire after tool completion but file system may buffer writes. Add small delay: sleep 0.1 before cargo check, or verify file timestamp: [ \"$FILE_PATH\" -nt /tmp/last-check ] to ensure fresh content is analyzed."
    }
  ],
  "source": "community"
}

{
  "slug": "terraform-plan-executor",
  "description": "Automatically runs terraform plan when .tf files are modified to preview infrastructure changes",
  "category": "hooks",
  "author": "JSONbored",
  "dateAdded": "2025-09-19",
  "tags": [
    "terraform",
    "infrastructure",
    "iac",
    "devops",
    "cloud"
  ],
  "hookType": "PostToolUse",
  "features": [
    "Automatic Terraform plan execution on file changes",
    "Configuration syntax validation and formatting",
    "Resource change preview and analysis",
    "Multi-provider support and validation",
    "Cost estimation and impact analysis",
    "Security and compliance checking"
  ],
  "useCases": [
    "Preview infrastructure changes before applying",
    "Validate Terraform configuration syntax",
    "Check for resource dependencies and conflicts",
    "Estimate costs of proposed infrastructure changes",
    "Ensure compliance with infrastructure policies",
    "Detect potential security issues in configurations",
    "Validate provider configurations and credentials",
    "Generate infrastructure change reports"
  ],
  "configuration": {
    "hookConfig": {
      "hooks": {
        "postToolUse": {
          "script": "./.claude/hooks/terraform-plan-executor.sh",
          "matchers": [
            "write",
            "edit"
          ]
        }
      }
    },
    "scriptContent": "#!/bin/bash\n\n# Read the tool input from stdin\nINPUT=$(cat)\nTOOL_NAME=$(echo \"$INPUT\" | jq -r '.tool_name')\nFILE_PATH=$(echo \"$INPUT\" | jq -r '.tool_input.file_path // .tool_input.path // \"\"')\n\nif [ -z \"$FILE_PATH\" ]; then\n  exit 0\nfi\n\n# Check if this is a Terraform file\nif [[ \"$FILE_PATH\" == *.tf ]] || [[ \"$FILE_PATH\" == *.tfvars ]]; then\n    echo \"ğŸ—ï¸ Terraform Plan Executor - Analyzing infrastructure changes...\"\n    echo \"ğŸ“„ File: $FILE_PATH\"\n    \n    # Check if file exists\n    if [ ! -f \"$FILE_PATH\" ]; then\n        echo \"âš ï¸ Terraform file not found: $FILE_PATH\"\n        exit 1\n    fi\n    \n    # Get the directory containing the Terraform file\n    TF_DIR=$(dirname \"$FILE_PATH\")\n    TF_FILE=$(basename \"$FILE_PATH\")\n    \n    echo \"ğŸ“ Working directory: $TF_DIR\"\n    cd \"$TF_DIR\" || exit 1\n    \n    # Check if Terraform is installed\n    if ! command -v terraform >/dev/null 2>&1; then\n        echo \"âš ï¸ Terraform not found - please install Terraform\"\n        echo \"ğŸ’¡ Install from: https://www.terraform.io/downloads\"\n        exit 1\n    fi\n    \n    # Get Terraform version\n    TF_VERSION=$(terraform version -json 2>/dev/null | jq -r '.terraform_version' 2>/dev/null || terraform version | head -1)\n    echo \"ğŸ“¦ Terraform version: $TF_VERSION\"\n    \n    # Step 1: Format check\n    echo \"\"\n    echo \"ğŸ¨ Checking Terraform formatting...\"\n    if terraform fmt -check \"$TF_FILE\"; then\n        echo \"âœ… Terraform formatting is correct\"\n    else\n        echo \"âš ï¸ Terraform formatting issues detected\"\n        echo \"ğŸ’¡ Run 'terraform fmt' to fix formatting\"\n        \n        # Auto-fix formatting if requested\n        echo \"ğŸ”§ Auto-fixing formatting...\"\n        terraform fmt \"$TF_FILE\"\n        echo \"âœ… Formatting applied to $TF_FILE\"\n    fi\n    \n    # Step 2: Validation\n    echo \"\"\n    echo \"ğŸ” Validating Terraform configuration...\"\n    if terraform validate; then\n        echo \"âœ… Terraform configuration is valid\"\n    else\n        echo \"âŒ Terraform validation failed\"\n        echo \"ğŸ’¡ Fix validation errors before proceeding\"\n        exit 1\n    fi\n    \n    # Step 3: Initialize if needed\n    if [ ! -d \".terraform\" ]; then\n        echo \"\"\n        echo \"ğŸ”„ Initializing Terraform...\"\n        if terraform init; then\n            echo \"âœ… Terraform initialized successfully\"\n        else\n            echo \"âŒ Terraform initialization failed\"\n            exit 1\n        fi\n    fi\n    \n    # Step 4: Run terraform plan\n    echo \"\"\n    echo \"ğŸ“‹ Running Terraform plan...\"\n    \n    PLAN_FILE=\".terraform-plan-$(date +%s)\"\n    \n    if terraform plan -out=\"$PLAN_FILE\" -compact-warnings; then\n        echo \"âœ… Terraform plan completed successfully\"\n        \n        # Analyze the plan\n        echo \"\"\n        echo \"ğŸ“Š Plan Analysis:\"\n        \n        # Show plan summary\n        if terraform show -json \"$PLAN_FILE\" >/dev/null 2>&1; then\n            PLAN_JSON=$(terraform show -json \"$PLAN_FILE\" 2>/dev/null)\n            \n            # Count changes\n            RESOURCES_TO_ADD=$(echo \"$PLAN_JSON\" | jq -r '.resource_changes[]? | select(.change.actions[]? == \"create\") | .address' 2>/dev/null | wc -l)\n            RESOURCES_TO_CHANGE=$(echo \"$PLAN_JSON\" | jq -r '.resource_changes[]? | select(.change.actions[]? == \"update\") | .address' 2>/dev/null | wc -l)\n            RESOURCES_TO_DESTROY=$(echo \"$PLAN_JSON\" | jq -r '.resource_changes[]? | select(.change.actions[]? == \"delete\") | .address' 2>/dev/null | wc -l)\n            \n            echo \"  â€¢ Resources to add: $RESOURCES_TO_ADD\"\n            echo \"  â€¢ Resources to change: $RESOURCES_TO_CHANGE\"\n            echo \"  â€¢ Resources to destroy: $RESOURCES_TO_DESTROY\"\n            \n            # Show resource details if any changes\n            if [ \"$RESOURCES_TO_ADD\" -gt 0 ] || [ \"$RESOURCES_TO_CHANGE\" -gt 0 ] || [ \"$RESOURCES_TO_DESTROY\" -gt 0 ]; then\n                echo \"\"\n                echo \"ğŸ” Detailed Changes:\"\n                \n                if [ \"$RESOURCES_TO_ADD\" -gt 0 ]; then\n                    echo \"  ğŸ“¦ Resources to create:\"\n                    echo \"$PLAN_JSON\" | jq -r '.resource_changes[]? | select(.change.actions[]? == \"create\") | \"    â€¢ \" + .address' 2>/dev/null\n                fi\n                \n                if [ \"$RESOURCES_TO_CHANGE\" -gt 0 ]; then\n                    echo \"  ğŸ”„ Resources to modify:\"\n                    echo \"$PLAN_JSON\" | jq -r '.resource_changes[]? | select(.change.actions[]? == \"update\") | \"    â€¢ \" + .address' 2>/dev/null\n                fi\n                \n                if [ \"$RESOURCES_TO_DESTROY\" -gt 0 ]; then\n                    echo \"  ğŸ—‘ï¸ Resources to destroy:\"\n                    echo \"$PLAN_JSON\" | jq -r '.resource_changes[]? | select(.change.actions[]? == \"delete\") | \"    â€¢ \" + .address' 2>/dev/null\n                fi\n            else\n                echo \"  â„¹ï¸ No infrastructure changes detected\"\n            fi\n        fi\n        \n        # Clean up plan file\n        rm -f \"$PLAN_FILE\"\n        \n    else\n        echo \"âŒ Terraform plan failed\"\n        rm -f \"$PLAN_FILE\"\n        exit 1\n    fi\n    \n    # Additional analysis\n    echo \"\"\n    echo \"ğŸ” Configuration Analysis:\"\n    \n    # Count resources in current file\n    RESOURCE_COUNT=$(grep -c '^resource ' \"$TF_FILE\" 2>/dev/null || echo 0)\n    DATA_COUNT=$(grep -c '^data ' \"$TF_FILE\" 2>/dev/null || echo 0)\n    VAR_COUNT=$(grep -c '^variable ' \"$TF_FILE\" 2>/dev/null || echo 0)\n    OUTPUT_COUNT=$(grep -c '^output ' \"$TF_FILE\" 2>/dev/null || echo 0)\n    \n    echo \"  â€¢ Resources defined: $RESOURCE_COUNT\"\n    echo \"  â€¢ Data sources: $DATA_COUNT\"\n    echo \"  â€¢ Variables: $VAR_COUNT\"\n    echo \"  â€¢ Outputs: $OUTPUT_COUNT\"\n    \n    # Check for common patterns\n    if grep -q 'provider ' \"$TF_FILE\" 2>/dev/null; then\n        echo \"  â€¢ ğŸ”Œ Provider configurations detected\"\n    fi\n    \n    if grep -q 'module ' \"$TF_FILE\" 2>/dev/null; then\n        echo \"  â€¢ ğŸ“¦ Module usage detected\"\n    fi\n    \n    if grep -q 'locals ' \"$TF_FILE\" 2>/dev/null; then\n        echo \"  â€¢ ğŸ·ï¸ Local values defined\"\n    fi\n    \n    # Security and best practices check\n    echo \"\"\n    echo \"ğŸ”’ Security Analysis:\"\n    \n    if grep -i 'password\\\\|secret\\\\|key' \"$TF_FILE\" 2>/dev/null | grep -v 'var\\.' | grep -v 'data\\.' >/dev/null; then\n        echo \"  â€¢ âš ï¸ Potential hardcoded secrets detected - use variables instead\"\n    fi\n    \n    if grep -q '0.0.0.0/0' \"$TF_FILE\" 2>/dev/null; then\n        echo \"  â€¢ âš ï¸ Open security group rules detected (0.0.0.0/0)\"\n    fi\n    \n    if ! grep -q 'tags\\\\|Tags' \"$TF_FILE\" 2>/dev/null && [ \"$RESOURCE_COUNT\" -gt 0 ]; then\n        echo \"  â€¢ ğŸ’¡ Consider adding resource tags for better management\"\n    fi\n    \n    echo \"\"\n    echo \"ğŸ’¡ Terraform Best Practices:\"\n    echo \"  â€¢ Use terraform fmt to maintain consistent formatting\"\n    echo \"  â€¢ Store sensitive values in variables, not hardcoded\"\n    echo \"  â€¢ Use remote state backend for team collaboration\"\n    echo \"  â€¢ Implement resource tagging strategy\"\n    echo \"  â€¢ Use terraform validate in CI/CD pipelines\"\n    echo \"  â€¢ Review plans carefully before applying\"\n    \n    echo \"\"\n    echo \"ğŸ¯ Terraform plan execution complete!\"\n    \nelse\n    echo \"â„¹ï¸ File is not a Terraform file: $FILE_PATH\"\nfi\n\nexit 0"
  },
  "source": "community"
}

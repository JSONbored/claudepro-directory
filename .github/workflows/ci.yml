name: CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'content/**/*.json'
      - 'templates/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'content/**/*.json'
      - 'content/guides/**/*.mdx'
      - 'templates/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/pull_request_template.md'
      - '**.md'
      - 'LICENSE'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      run-tests: ${{ steps.filter.outputs.code == 'true' || steps.filter.outputs.tests == 'true' }}
    steps:
      - uses: actions/checkout@v5
      - name: Check changed files
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            code:
              - 'src/**/*.{ts,tsx,js,jsx}'
              - 'package.json'
              - 'package-lock.json'
              - 'next.config.mjs'
              - 'tailwind.config.ts'
              - 'scripts/**'
              - 'config/**'
            tests:
              - 'tests/**'
              - 'src/**/*.test.{ts,tsx,js,jsx}'
              - 'jest.config.*'
              - 'config/tools/playwright.config.ts'
  quality:
    name: Code Quality (${{ matrix.check }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        check: [lint, type-check]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - uses: ./.github/actions/setup-node-deps

      - name: Run ${{ matrix.check }}
        run: npm run ${{ matrix.check }}

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true  # Don't block CI on test failures (SEO tests can be fixed iteratively)
    # Only run coverage on main branch (production)
    # PRs run tests without coverage for faster feedback
    needs: [detect-changes]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - uses: ./.github/actions/setup-node-deps

      - name: Run tests (with coverage on main)
        if: needs.detect-changes.outputs.run-tests == 'true'
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "Running tests with coverage (main branch)"
            npm run test:coverage
          else
            echo "Running tests without coverage (PR/branch)"
            npm run test:unit
          fi

      - name: Skip tests (no relevant changes)
        if: needs.detect-changes.outputs.run-tests != 'true'
        run: echo "Skipping tests: no relevant code/test changes detected"

      - name: Upload coverage reports to Codecov (main only)
        if: github.ref == 'refs/heads/main' && needs.detect-changes.outputs.run-tests == 'true'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      - name: Generate coverage summary (main only)
        if: github.ref == 'refs/heads/main' && needs.detect-changes.outputs.run-tests == 'true'
        run: |
          if [ -f ./coverage/coverage-summary.json ]; then
            echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            node -e "
              const summary = require('./coverage/coverage-summary.json');
              const total = summary.total;
              console.log('| Metric | Coverage |');
              console.log('|--------|----------|');
              console.log('| Lines | ' + total.lines.pct.toFixed(2) + '% |');
              console.log('| Statements | ' + total.statements.pct.toFixed(2) + '% |');
              console.log('| Functions | ' + total.functions.pct.toFixed(2) + '% |');
              console.log('| Branches | ' + total.branches.pct.toFixed(2) + '% |');
            " >> $GITHUB_STEP_SUMMARY
          fi

  build:
    name: Build & Verify
    uses: ./.github/workflows/build-reusable.yml
    needs: [quality, test]
    with:
      cache-key-suffix: 'ci'
      upload-artifact: false

name: Sync Content to Supabase

# Triggers: PRs, pushes to any branch with content changes, manual dispatch
on:
  pull_request:
    branches: ['**']  # All branches
    paths:
      - 'content/**/*.json'
      - 'CHANGELOG.md'
  push:
    branches: ['**']  # All branches
    paths:
      - 'content/**/*.json'
      - 'CHANGELOG.md'
  workflow_dispatch:
    inputs:
      full_sync:
        description: 'Run full sync (all 315 files)'
        required: false
        type: boolean
        default: false

jobs:
  sync:
    name: Sync Content Items
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate git diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Detect changed and deleted files
        id: changes
        run: |
          # Determine base SHA for comparison
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            BASE_SHA="${{ github.event.before }}"
          else
            # workflow_dispatch - will use full sync mode if requested
            BASE_SHA="${{ github.sha }}"
          fi

          # Detect changed files (ACMRT = Added, Copied, Modified, Renamed, Type changed)
          CHANGED=$(git diff --name-only --diff-filter=ACMRT $BASE_SHA ${{ github.sha }} \
            | grep -E '^content/.*\.json$|^CHANGELOG\.md$' || true)

          # Detect deleted files
          DELETED=$(git diff --name-only --diff-filter=D $BASE_SHA ${{ github.sha }} \
            | grep -E '^content/.*\.json$' || true)

          # Convert newlines to spaces for env var
          CHANGED_SPACE=$(echo "$CHANGED" | tr '\n' ' ')
          DELETED_SPACE=$(echo "$DELETED" | tr '\n' ' ')

          # Output for logging
          echo "Changed files: $CHANGED_SPACE"
          echo "Deleted files: $DELETED_SPACE"

          # Set outputs for next step
          echo "changed_files=$CHANGED_SPACE" >> $GITHUB_OUTPUT
          echo "deleted_files=$DELETED_SPACE" >> $GITHUB_OUTPUT

          # Count files for conditional execution
          CHANGED_COUNT=$(echo "$CHANGED" | grep -c . || echo "0")
          DELETED_COUNT=$(echo "$DELETED" | grep -c . || echo "0")
          TOTAL_COUNT=$((CHANGED_COUNT + DELETED_COUNT))

          echo "total_changes=$TOTAL_COUNT" >> $GITHUB_OUTPUT

      - name: Run incremental sync
        if: |
          github.event_name != 'workflow_dispatch' &&
          steps.changes.outputs.total_changes > 0
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          CHANGED_FILES: ${{ steps.changes.outputs.changed_files }}
          DELETED_FILES: ${{ steps.changes.outputs.deleted_files }}
        run: |
          echo "üîÑ Running incremental sync..."
          echo "Changed files: $CHANGED_FILES"
          echo "Deleted files: $DELETED_FILES"
          pnpm tsx scripts/sync/sync-content-supabase-client.ts --incremental

      - name: Run full sync
        if: |
          github.event_name == 'workflow_dispatch' &&
          github.event.inputs.full_sync == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        run: |
          echo "üîÑ Running full sync (all 315 files)..."
          pnpm tsx scripts/sync/sync-content-supabase-client.ts --full

      - name: No changes detected
        if: |
          github.event_name != 'workflow_dispatch' &&
          steps.changes.outputs.total_changes == 0
        run: |
          echo "‚ÑπÔ∏è  No content changes detected - skipping sync"
          echo "Workflow triggered but no content/**/*.json or CHANGELOG.md files were modified"

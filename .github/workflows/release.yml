# Create Release
# Optimizations: specific trigger (tag pushes only), continues on non-critical errors
# Uses actions/checkout@v6 with fetch-depth: 0 (required for changelog generation)
#
# **What it does:**
# 1. Extracts version from tag name
# 2. Generates changelog entry for the release (if git-cliff is available)
# 3. Creates GitHub Release with release notes
#
# **Complete Workflow:**
# 1. Developer generates changelog: `pnpm changelog:generate`
# 2. Developer bumps version: `pnpm bump:minor`
# 3. Developer commits: `git commit -m "chore: bump version to X.Y.Z"`
# 4. Developer tags: `git tag vX.Y.Z && git push origin main --tags`
# 5. This workflow automatically creates the GitHub release
#
# **Related Files:**
# - packages/generators/src/commands/bump-version.ts - Version bump script
# - packages/generators/src/commands/changelog.ts - Changelog generation
# - apps/web/src/components/core/layout/footer.tsx - Version display in footer
name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Matches v1.2.3 format

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create releases
    
    steps:
      # Checkout first to make composite action files available
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # fetch-depth: 0 needed for changelog generation (requires git history)
      - uses: ./.github/actions/setup
        with:
          skip-checkout: true # Already checked out above
      
      - name: Extract version from tag
        id: tag_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Verify changelog command exists
        run: |
          if ! grep -q '"changelog:generate"' package.json; then
            echo "❌ changelog:generate script not found in package.json" >&2
            exit 1
          fi
          echo "✅ changelog:generate command verified in package.json"
      
      - name: Generate changelog for release
        id: changelog
        run: |
          # Generate changelog entry
          pnpm changelog:generate --tag v${{ steps.tag_version.outputs.VERSION }} || {
            echo "⚠️ Changelog generation failed (non-critical - will use auto-generated notes)" >&2
            echo "CHANGELOG_GENERATED=false" >> $GITHUB_OUTPUT
            exit 0
          }
          echo "CHANGELOG_GENERATED=true" >> $GITHUB_OUTPUT
        continue-on-error: true  # Don't fail workflow if changelog generation fails (auto-generated notes are fallback)
      
      - name: Verify CHANGELOG.md exists and prepare release body
        id: release_body
        run: |
          # Check if CHANGELOG.md exists
          if [ ! -f "CHANGELOG.md" ]; then
            echo "⚠️ CHANGELOG.md not found - release will use auto-generated notes only" >&2
            echo "USE_CHANGELOG=false" >> $GITHUB_OUTPUT
            echo "BODY_PATH=" >> $GITHUB_OUTPUT
          else
            echo "✅ CHANGELOG.md found"
            # Only use CHANGELOG.md if it was generated successfully in this run
            if [ "${{ steps.changelog.outputs.CHANGELOG_GENERATED }}" == "true" ]; then
              echo "USE_CHANGELOG=true" >> $GITHUB_OUTPUT
              echo "BODY_PATH=CHANGELOG.md" >> $GITHUB_OUTPUT
            else
              echo "USE_CHANGELOG=false" >> $GITHUB_OUTPUT
              echo "BODY_PATH=" >> $GITHUB_OUTPUT
            fi
          fi
        continue-on-error: true  # Don't fail if CHANGELOG.md is missing (auto-generated notes are fallback)
      
      - name: Create GitHub Release (with CHANGELOG.md)
        if: steps.release_body.outputs.BODY_PATH != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release v${{ steps.tag_version.outputs.VERSION }}
          body_path: ${{ steps.release_body.outputs.BODY_PATH }}
          draft: false
          prerelease: false
          generate_release_notes: true  # Also generate notes (will be merged with body_path content)
      
      - name: Create GitHub Release (without CHANGELOG.md)
        if: steps.release_body.outputs.BODY_PATH == ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release v${{ steps.tag_version.outputs.VERSION }}
          # body_path omitted - will use generate_release_notes as primary source
          draft: false
          prerelease: false
          generate_release_notes: true  # Primary source when CHANGELOG.md is missing or generation failed

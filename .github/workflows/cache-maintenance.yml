# Cache Maintenance - Optimized for resource efficiency
# - Only runs weekly (scheduled) or manually (workflow_dispatch)
# - Shallow git clone (fetch-depth: 1) - only need current commit
# - Minimal permissions (only actions: write for cache deletion)
name: Cache Maintenance

on:
  # Weekly scheduled cleanup (Sunday 2am UTC) - prevents cache bloat
  schedule:
    - cron: '0 2 * * 0'
  # Manual trigger for immediate cleanup if needed
  workflow_dispatch:
    inputs:
      delete_all:
        description: 'Delete ALL caches (use sparingly)'
        required: false
        default: false
        type: boolean

concurrency:
  group: cache-maintenance
  cancel-in-progress: false

jobs:
  cleanup:
    name: Cleanup Old Caches
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      actions: write  # Required to delete caches

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Shallow clone - only need current commit for cache operations

      - name: Cleanup old caches
        run: |
          echo "üßπ Starting cache cleanup..."

          # Install gh actions-cache extension
          gh extension install actions/gh-actions-cache || true

          echo "üìä Current cache status BEFORE cleanup:"
          gh actions-cache list --limit 50 || echo "No caches found"
          echo ""

          if [ "${{ inputs.delete_all }}" = "true" ]; then
            echo "‚ö†Ô∏è Deleting ALL caches (manual trigger)..."
            gh actions-cache delete --all --repo ${{ github.repository }} || true
          else
            echo "üóëÔ∏è Deleting old/stale caches (keeping recent ones)..."
            
            # Delete caches older than 7 days for closed PRs
            echo "Cleaning up PR caches..."
            gh actions-cache list --limit 100 | \
              grep -E 'refs/pull/[0-9]+' | \
              awk '{print $1}' | \
              while read -r key; do
                echo "  Deleting: $key"
                gh actions-cache delete "$key" --repo ${{ github.repository }} --confirm || true
              done
            
            # Delete stale turbo caches (keep most recent 5)
            echo "Cleaning up old turbo caches..."
            gh actions-cache list --key "Linux-turbo-" --limit 100 | \
              tail -n +6 | \
              awk '{print $1}' | \
              while read -r key; do
                echo "  Deleting: $key"
                gh actions-cache delete "$key" --repo ${{ github.repository }} --confirm || true
              done
          fi

          echo ""
          echo "üìä Current cache status AFTER cleanup:"
          gh actions-cache list --limit 20 || echo "No caches found"

          echo ""
          echo "‚úÖ Cache cleanup complete"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

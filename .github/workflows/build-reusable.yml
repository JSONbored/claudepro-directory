name: Build (Reusable)

on:
  workflow_call:
    inputs:
      cache-key-suffix:
        description: 'Suffix for cache key (e.g., pr, base, lighthouse)'
        type: string
        required: false
        default: 'default'
      upload-artifact:
        description: 'Whether to upload build artifact'
        type: boolean
        required: false
        default: true
      checkout-ref:
        description: 'Git ref to checkout (branch, tag, or SHA). Defaults to triggering ref.'
        type: string
        required: false
        default: ''
    outputs:
      artifact-name:
        description: 'Name of uploaded build artifact'
        value: ${{ jobs.build.outputs.artifact-name }}

jobs:
  build:
    name: Build Next.js Application
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Reduced from 15min (with optimized caching)
    outputs:
      artifact-name: ${{ steps.artifact-info.outputs.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.checkout-ref }}
          fetch-depth: 1  # Shallow clone for speed

      - name: Restore prebuilt artifact (if available)
        id: restore-artifact
        continue-on-error: true
        uses: actions/download-artifact@v6
        with:
          name: build-${{ inputs.cache-key-suffix }}-${{ github.sha }}
          path: ./

      - name: Restore full Next.js build from cache (cross-workflow)
        id: restore-next
        uses: actions/cache/restore@v4
        with:
          path: .next
          key: next-build-${{ inputs.cache-key-suffix }}-${{ github.sha }}
          restore-keys: |
            next-build-${{ inputs.cache-key-suffix }}-
            next-build-

      - name: Check restored build
        id: check-restored
        run: |
          if [ -d ".next" ]; then
            echo "restored=true" >> $GITHUB_OUTPUT
            echo "✅ Reused existing build artifact"
          else
            echo "restored=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-deps

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next/cache
          # Only invalidate on dependency/config changes (Next.js handles code changes incrementally)
          key: ${{ runner.os }}-nextjs-${{ inputs.cache-key-suffix }}-${{ hashFiles('**/pnpm-lock.yaml', 'next.config.mjs', 'tailwind.config.ts') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ inputs.cache-key-suffix }}-
            ${{ runner.os }}-nextjs-

      - name: Build Next.js application
        if: steps.check-restored.outputs.restored != 'true'
        run: pnpm build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: Verify build output
        run: |
          if [ ! -d ".next" ]; then
            echo "❌ Build failed - .next directory not found"
            exit 1
          fi

          echo "✅ Build successful"
          echo "Build size: $(du -sh .next | cut -f1)"

          # Verify critical build outputs
          if [ -f ".next/BUILD_ID" ]; then
            echo "Build ID: $(cat .next/BUILD_ID)"
          fi

      - name: Save full Next.js build to cache
        if: steps.restore-next.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: .next
          key: next-build-${{ inputs.cache-key-suffix }}-${{ github.sha }}

      - name: Set artifact name
        id: artifact-info
        run: |
          ARTIFACT_NAME="build-${{ inputs.cache-key-suffix }}-${{ github.sha }}"
          echo "name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "Artifact name: ${ARTIFACT_NAME}"

      - name: Upload build artifact
        if: inputs.upload-artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.artifact-info.outputs.name }}
          path: |
            .next/**
            !.next/cache/**
            !.next/trace/**
            !.next/standalone/**
            .next/BUILD_ID
            .next/package.json
            package.json
            next.config.mjs
          retention-days: 1
          compression-level: 9  # Max compression for 85%+ size reduction

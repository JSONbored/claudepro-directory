# Frontend Architecture Blueprint — Inventory (2025-11-24)

This document extends the earlier route audit into a full inventory covering every major page, route segment, API endpoint, and edge surface in the repository. It groups surfaces into archetypes so we can reason about rendering/runtime strategy, data dependencies, personalization, and caching in a consistent way.

## 1. Discovery & Marketing Routes

| Archetype | Paths / Directories | Runtime / Config | Data Sources & Clients | Personalization | Cache / Invalidation | Notes |
| --- | --- | --- | --- | --- | --- | --- |
| **Home / Landing** | `/` (`page.tsx`) | Node runtime, default static (no `dynamic`). `LazySection` + Suspense for content sections. | `getHomepageData`, `getSearchFacets`, `getHomepageCategoryIds`, featured jobs/contributors via Supabase RPCs. | None (only aggregate stats). | Data cached via `fetchCached` (`cache.homepage.ttl_seconds = 3600`, `cache.search_facets.ttl_seconds = 3600`). Route HTML lacks `revalidate`. | Candidate for ISR + Partial Prerendering (PPR). `RecentlyViewedRail` is client-only island. |
| **Trending** | `/trending` (`trending/page.tsx`) | `dynamic = 'force-dynamic'`. Node runtime. | `getTrendingPageData` RPC. | Query-param filters only; no cookies. | RPC cached (home/trending tags). Route uncached. | Should switch to ISR; current dynamic flag only exists due to feature-flag paranoia. |
| **Category Landing Skeletons** | `/agents`, `/mcp`, `/commands`, `/rules`, `/hooks`, `/statuslines`, `/skills` (directory contains loading states) | Loading UI only; actual data served by `[category]/page.tsx`. | N/A (just skeletons). | None. | Inherits `[category]` caching once ISR enabled. | Keep skeletons lightweight so they can run under streaming. |
| **Category Listing** | `/[category]` | `dynamic = 'force-dynamic'`. Node runtime. | `getCategoryConfig`, `getContentByCategory`. | None. | Data cached (`cache.content_list.ttl_seconds = 1800`); HTML re-rendered every hit. | Plan: pre-build via `generateStaticParams` + ISR, rely on `api/revalidate` to bust caches. |
| **Detail Pages** | `/[category]/[slug]` | Dynamic segment (no `dynamic` flag). Node runtime. | `getContentDetailCore`, `getContentAnalytics`, `getRelatedContent`, optional `featureFlags.contentDetailTabs`. | None (except recently viewed tracker client-side). | Data cached (`cache.content_detail.ttl_seconds = 7200`). Route HTML currently SSR per request. | Add `revalidate = 7200` + rely on `revalidatePath`. Leverage existing Suspense for analytics (PPR-ready). |
| **Marketing / Brochure** | `/community`, `/companies`, `/consulting`, `/partner`, `/contact`, `/commands`, `/collections`, `/hooks`, `/mcp`, `/statuslines`, `/skills`, `/privacy`, `/terms`, `/cookies`, `/accessibility`, `/help`, `/test-flags`, `/(marketing)` placeholder | Most set `dynamic = 'force-dynamic'` despite deterministic data. Node runtime. | Mix of `getCommunityDirectory`, `getCompaniesList`, `getHomepageData`, constants. | None. | RPCs cached (30–60 min) but HTML not cached. | Remove unnecessary `dynamic` flags, set `revalidate` (~3600s) to match data TTL. For pages needing feature flags, isolate them via client components/server actions. |
| **Tools / Interactive Marketing** | `/tools/config-recommender` | `dynamic = 'force-dynamic'`. Node runtime. Client quiz + newsletter CTA. | Minimal server data; uses `generatePageMetadata` + static copy. | Optional newsletter CTA variant (flags). | No caching—page always SSR. | Convert to static/ISR: isolate flag-driven bits inside client component calling server action if needed. |
| **Submit** | `/submit` | `dynamic = 'force-dynamic'`. Node runtime. | `getContentTemplates`, `getSubmissionDashboard`, `getSubmissionFormFields`. | Form state client-side; no cookies until user logs in. | RPC outputs cached via data layer (TTL from `cache.submission_dashboard.ttl_seconds = 900`). HTML uncached. | Could adopt ISR for hero/stats while keeping form client-side. |
| **Trending / Skills / Collections Aliases** | `/skills`, `/collections`, `/commands`, etc. (top-level directories) | Provide `loading`/`error` states; real content served via `[category]`. | N/A | None | N/A | Ensure duplicates don’t inflate build time once `[category]` is static. |

## 2. Search, Discovery & User Content

| Archetype | Paths / Directories | Runtime / Config | Data Sources & Clients | Personalization | Cache / Invalidation | Notes |
| --- | --- | --- | --- | --- | --- | --- |
| **Search** | `/search` | `dynamic = 'force-dynamic'`. Node runtime with Suspense for sidebar. | `searchContent`, `getSearchFacets`, `getHomepageData` for zero-state. | Filters derived from query params only. | `searchContent` cached per-query via `fetchCached` (`cache.content_list.ttl_seconds = 1800`); page HTML uncached. | Candidate for SSR streaming or partial static shell (PPR). Need to gate zero-state homepage fetch behind `!query && !filters`. |
| **User Profiles** | `/u/[slug]` | `revalidate = false` (fully dynamic). Node runtime. | `getAuthenticatedUser`, `getPublicUserProfile`. | Viewer-specific follow state; optional `currentUser` gating. | Data cached (`cache.user_profile.ttl_seconds = 1800`) but HTML always SSR. | Consider ISR with `viewer` param fallback: serve cached public profile, hydrate follow buttons client-side. |
| **Trending APIs** | `/api/templates`, `/api/stats/social-proof`, `/api/revalidate`, `/api/og` | Next API routes. `/api/og` uses `runtime = 'edge'`; others implicit Node. | Supabase RPCs via `createSupabaseServerClient`. | None. | Templates + stats set `Cache-Control: public, s-maxage=300, stale-while-revalidate=600`. Revalidate/OG uncached. | Add explicit `runtime = 'nodejs'` for stats/templates/revalidate to avoid accidental Edge deploy. |

## 3. Authenticated & Account Surfaces

| Archetype | Paths / Directories | Runtime / Config | Data Sources & Clients | Personalization | Cache / Invalidation | Notes |
| --- | --- | --- | --- | --- | --- | --- |
| **Account Root** | `/account/page.tsx` + `/account/layout.tsx` | `dynamic = 'force-dynamic'`. Node runtime. | `getAuthenticatedUser`, `getAccountDashboard`, `getUserLibrary`, `getHomepageData`. | Fully personalized; requires Supabase auth cookies. | Data cached per user (`cache.account.ttl_seconds = 300`). HTML SSR per request. | Keep SSR but declare `runtime = 'nodejs'` to prevent Edge. Share memoized helper to avoid duplicate RPCs across subroutes. |
| **Account Subroutes** | `/account/activity`, `/account/bookmarks`, `/account/companies`, `/account/connected-accounts`, `/account/jobs`, `/account/library`, `/account/settings`, `/account/sponsorships`, `/account/submissions`, etc. | Same as root (dynamic SSR). Each page imports targeted data helpers (bookmarks, user companies, sponsorship analytics, submissions). | Supabase authenticated RPCs via `fetchCached` with `useAuth`. | All personalized. | TTL defaults to `cache.account.ttl_seconds`. | Document owner + data per route; ensure no page accidentally imports feature flags. |
| **Auth Entry** | `(auth)/login`, `(auth)/auth-code-error`, `(auth)/layout` | Primarily server components with client panels. `Login` integrates Supabase auth. | `generatePageMetadata` only; login logic handled client-side. | None beyond Supabase. | Safe for static/ISR, but confirm dynamic imports (feature flags). | Could pre-render to reduce cold starts; ensure forms rely on server actions or API routes. |

## 4. Jobs & Commerce

| Archetype | Paths / Directories | Runtime / Config | Data Sources & Clients | Personalization | Cache / Invalidation | Notes |
| --- | --- | --- | --- | --- | --- | --- |
| **Jobs Listing** | `/jobs/page.tsx` | `dynamic = 'force-dynamic'`. `revalidate = false`. | `getFilteredJobs` (SearchService RPC). | Query-param filters only. | RPC results cached (`cache.jobs.ttl_seconds = 1800`). HTML re-rendered on every hit. | Convert to hybrid: static hero w/ `revalidate = 900`, stream filtered results via deferred server components. |
| **Job Detail / CRUD** | `/account/jobs/new`, `/account/jobs/[id]/edit`, `/account/jobs/[id]/analytics`, `/account/jobs/page.tsx` | SSR with Supabase auth. | `getUserDashboard`, job-specific RPCs. | Fully personalized. | `cache.account.ttl_seconds`. | Keep SSR, but ensure runtime pinned to Node, and consider splitting analytics into client island to reduce blocking. |
| **Partner / Sponsorship** | `/partner`, `/account/sponsorships`, `/account/sponsorships/[id]` | Mix of marketing + authenticated pages. | `getSponsorshipAnalytics`, `getUserSponsorships`. | Auth-specific data for account routes. | `cache.account.ttl_seconds`. | Align marketing page with ISR; keep account routes SSR. |

## 5. Tools, User Utilities, and Support

| Archetype | Paths / Directories | Runtime / Config | Data Sources & Clients | Personalization | Cache / Invalidation | Notes |
| --- | --- | --- | --- | --- | --- | --- |
| **Config Recommender** | `/tools/config-recommender` | Dynamic SSR (see §1). | Mostly client logic. | None. | None. | Good candidate for full static export. |
| **Support / Docs** | `/help`, `/rules`, `/privacy`, `/terms`, `/cookies`, `/accessibility` | Currently SSR (some `dynamic` flags). | Static copy + `generatePageMetadata`. | None. | Could be static assets. | Migrate to pure markdown/MDX or SSG. |
| **Test Harness** | `/test-flags` | Typically SSR to demonstrate feature flags. | Feature flag helpers. | None. | N/A. | Keep dynamic but isolate in route group to avoid tree-shaking issues. |
| **Error/Loading** | `error.tsx`, `global-error.tsx`, `loading.tsx`, `not-found.tsx`, category-specific `loading.tsx` files. | Server components executed during boundary errors. | N/A | N/A | N/A | Ensure they remain lightweight and deterministic (no data fetching). |

## 6. API Routes & Edge Functions

| Surface | Paths / Directories | Runtime / Config | Data Sources & Clients | Cache / Observability | Notes |
| --- | --- | --- | --- | --- | --- |
| **Next API routes** | `/api/templates`, `/api/stats/social-proof`, `/api/revalidate`, `/api/og` | Node (templates, stats, revalidate) + Edge (`/api/og`). | Supabase RPCs via server client; `revalidate` uses `revalidatePath`/`revalidateTag`. | Templates/stats respond with `Cache-Control: public, s-maxage=300, stale-while-revalidate=600`. Others uncached. | Add structured logging (payload metadata, cache hits). Explicit `runtime = 'nodejs'` recommended for non-Edge handlers. |
| **Edge — `public-api`** | `apps/edge/functions/public-api` | Deno Edge runtime. Provides OG generation, search endpoints, etc. | Calls shared data-layer services (`SearchService`, `ContentService`). | Observability via Supabase logs + Vercel Edge metrics. | Ensure `type` scoping fix (already completed) and align with web runtime caching (tags). |
| **Edge — `flux-station`** | `apps/edge/functions/flux-station` | Handles webhooks, notifications, queue processing. | Supabase `pgmq`, webhook ingestion, secret-guarded routes. | Relies on environment secrets (`CRON_WORKER_SECRET`, `INTERNAL_API_KEY`). | Documented in runbook; continue to enforce auth and queue cleanup. |

## 7. Summary of Immediate Inventory Gaps

1. **Marketing pages default to SSR despite static data** – remove `dynamic` flags, set `revalidate` values matching `cache_configs`.
2. **Search/Trending/Tools rely on defensive `dynamic = 'force-dynamic'`** – verify no feature flag imports; transition to ISR/PPR to reduce cold starts.
3. **User profile pages disable ISR entirely (`revalidate = false`)** – evaluate hybrid approach (cache public data, client-side personalization).
4. **Jobs page disables revalidation even though results are cached** – adopt hybrid streaming architecture.
5. **API routes lack explicit runtimes/logging** – add `runtime = 'nodejs'`, structured logs, and align `Cache-Control` with TTL values.
6. **Edge functions + Next routes share caches but not governance** – track cache tags centrally so `api/revalidate` and Supabase triggers stay in sync.

This inventory will feed Task 2 (shared systems map) so we can formalize the runtime and caching expectations for data helpers, feature flags, analytics, notifications, and design system components.

## 8. Shared Systems Map (Runtime + Caching Constraints)

| System | Location(s) | Runtime Expectations | Responsibilities & Data Sources | Caching / State Management | Risks & Guardrails |
| --- | --- | --- | --- | --- | --- |
| **Supabase Data Layer** | `packages/data-layer` generated services (`ContentService`, `SearchService`, `AccountService`, etc.) | Runs on Node/Edge environments with Supabase access; generally invoked server-side via `fetchCached`. | Strongly typed RPC wrappers over Supabase functions (`get_content_detail_core`, `search_unified`, etc.) consumed by `@heyclaude/web-runtime`. | Responses memoized with `fetchCached` + `unstable_cache`, keyed by TTL/tag combos from `cache-config`. | Never import services directly inside client components. Always use `fetchCached`/server actions to keep secrets + cache tags centralized. |
| **Supabase Server / Anon Clients** | `packages/web-runtime/src/supabase/server.ts`, `server-anon.ts` | Node runtime only (requires `next/headers` cookies). | Provides authenticated Supabase access for account routes, analytics, notifications, PPR data. | Works with `fetchCached` when `useAuth` flag is set; TTLs sourced from cache config. | Declare `export const runtime = 'nodejs'` on any route invoking these helpers to avoid accidental Edge deployments. |
| **Caching Layer** | `packages/web-runtime/src/cache/fetch-cached.ts`, `cache-config.ts`, dynamic `cache_configs` | Server-side; may read Statsig dynamic configs unless `isBuildTime()`. | Wraps Supabase calls with `unstable_cache`, automatically tagging results and honoring TTL keys (e.g., `cache.homepage.ttl_seconds`). | TTL defaults defined in `CACHE_TTL_KEYS`; invalidation tags enumerated in `CACHE_INVALIDATE_KEYS`; `/api/revalidate` plus Supabase triggers bust caches. | Route components must set `revalidate` (or `dynamic`) values matching their data TTLs so HTML doesn’t outlive cached data. Document cache tags used per route. |
| **Feature Flags & Experiments** | `packages/web-runtime/src/feature-flags/*`, `FeatureFlagsProvider` in `apps/web/src/app/layout.tsx` | Node runtime only; uses Vercel Flags SDK + Statsig. Imports must be lazy to avoid build-time Edge Config access. | Provides gates, experiments, and dynamic configs (app/component/email/polling/etc.). | Flags evaluated per request via deduped helpers and optionally cached via React `cache()`. | Never import `featureFlags` at route module scope. Use helpers like `getLayoutFlags` or server actions to keep static analysis happy. |
| **Analytics & Pulse** | `packages/web-runtime/src/pulse.ts`, `pulse-client.ts`, `apps/web/src/components/core/infra/Pulse*` | Server helpers enqueue events via Supabase `pgmq`; client components lazy-load analytics scripts post-idle. | Tracks searches, clicks, page views, etc., forwarding to `flux-station`. | No cache; relies on queue durability. Client `PulseCannon` defers execution to protect LCP. | Sanitize metadata and guard payload sizes. Fail closed (no-op) when Supabase creds absent. |
| **Notifications System** | `packages/web-runtime/src/notifications.ts`, `apps/web/src/components/providers/notifications-provider.tsx`, edge `flux-station/routes/notifications/*` | Node runtime for server helpers; client provider hydrates via server actions/API. Edge function enforces auth secrets. | Fetches/dismisses notifications through `flux-station`, renders toasts/sheets client-side. | Server caches notifications per user (`cache.notifications.ttl_seconds`); client state stored in provider context. | Every API call must include auth tokens; keep provider client-only to avoid forcing route SSR. Debounce dismissal calls. |
| **Design System & Layout Providers** | `apps/web/src/app/layout.tsx`, `packages/web-runtime/src/ui`, theme + notifications providers | Root layout is server component but wraps client providers. Must remain Node runtime due to Supabase + feature flags. | Handles fonts, theme, navigation, newsletter modals, structured data, notifications, `PulseCannon`. | No caching at layout level; subroutes rely on `fetchCached`. Client providers use local storage/context. | Keep layout deterministic—avoid accidental client imports outside providers; lazily load flag data to prevent double fetching. |
| **`shared-runtime` Utilities** | `packages/shared-runtime` (logging, rate limiters, OG helpers, webhook validators) | Designed for Node and Edge (Deno-compatible). | Supplies cross-environment helpers for OG image routes, middleware, webhook validation, logging. | Stateless/pure functions. | Use for edge functions/public API to stay parity with server logic. Keep dependencies Edge-safe. |
| **Edge Functions** | `apps/edge/functions/public-api`, `apps/edge/functions/flux-station`, `packages/edge-runtime` | Deno runtime. `public-api` exposes OG/search; `flux-station` handles webhooks, queue workers. | Consume shared-runtime helpers + Supabase service clients via fetch. | No caching beyond function lifetime; rely on Supabase `pgmq` for queue persistence. | Document required secrets (`CRON_WORKER_SECRET`, `INTERNAL_API_KEY`). Treat as external APIs from Next app (never import edge code). |
| **Logging & Observability** | `packages/web-runtime/src/logger.ts`, `trace.ts`, `error-utils.ts` + Vercel/Flux Station logs | Node preferred (uses `pino`). Browser logging toggled via env flags for debugging. | Centralizes sanitization + structured context for server logs; used by data helpers, feature flags, notifications. | No caching; logs stream to stdout/Edge. | Keep messages sanitized, avoid PII. Disable `NEXT_PUBLIC_LOGGER_CONSOLE` in production to prevent client log noise. |

### Key Takeaways for System Integration

1. **Align route configs with cache tags.** When `fetchCached` uses a TTL/tag, the consuming route must set `revalidate` to that TTL (or reduce to `dynamic` only when personalization demands it) so HTML doesn’t outlive cache entries.
2. **Isolate client-only behavior.** Notifications, analytics, and flag-driven widgets should live in client providers or islands, allowing surrounding routes to remain ISR/PPR-friendly.
3. **Gate feature flag imports.** Route modules should only depend on helpers (`getLayoutFlags`, server actions) rather than importing Statsig/Vercel SDKs directly.
4. **Standardize logging/telemetry.** Use `logger` and `pulse` helpers for structured logs and analytics to avoid ad-hoc fetches or console noise.
5. **Document external service expectations.** Integrations with flux-station, pgmq, or edge functions need explicit env requirements and fallback behavior for ISR/static generation.

## 9. Modernization Playbooks (Per Archetype)

| Archetype | Rendering & Revalidation | Data Access & Caching | Client / Edge Guidance | Observability & Testing |
| --- | --- | --- | --- | --- |
| **Marketing & Landing (/, /community, /companies, /partner, etc.)** | Default to ISR with `revalidate = 1800–3600` tied to `cache.homepage`/`cache.community`. Use PPR (`Suspense`) for heavy rails (stats, CTAs). | Fetch aggregate data via `fetchCached`; avoid `force-dynamic`. For hero stats, rely on cached RPC outputs and `revalidateTag('homepage')` on updates. | Keep interactive widgets (notifications, newsletter modals, recently-viewed rails) as client islands so the shell stays static. | Add synthetic Lighthouse runs per deploy; watch cache hit rate for `homepage` and marketing tags. |
| **Search & Discovery (/search, /trending, /[category])** | Use streaming SSR or PPR: static shell + deferred results component. `revalidate = 1800` for zero-state data; keep per-query results `cache: 'no-store'`. Category pages should be ISR with `generateStaticParams`. | Gate zero-state fetches behind `!query && !filters`; share cache tags with detail pages. Align `/api/revalidate` to flush `search`, `trending`, and category tags. | Keep RecentlyViewed/QuickFilters as client components. Offload heavy ranking to edge APIs if needed (public search). | Instrument search latency + cache hits; ensure `pulse.search` events fire and log filters applied. |
| **Detail & Deep Content (/[category]/[slug], `/submit` detail states)** | Adopt ISR with `revalidate = cache.content_detail.ttl_seconds` (7200). Use PPR to stream analytics/related rails. | Continue splitting `getContentDetailCore` (blocking) vs analytics/related (Suspense). On updates, invalidation via `revalidatePath` + tags (`content`, `homepage`). | Recently viewed tracker remains client-only. Feature flags for tabs should load lazily to avoid forcing SSR. | Track Route Cache storage + hit rate via Vercel analytics. Add tests verifying `revalidatePath` triggered by Supabase webhooks. |
| **Personalized Account & Auth Routes (/account/**, /u/[slug], (auth))** | Keep SSR (Node runtime) with `dynamic = 'force-dynamic'` only where cookies required. Consider ISR for public profile shells while hydrating personalized widgets client-side. | Use authenticated `fetchCached` (`cache.account.ttl_seconds = 300`). Memoize bundles to avoid duplicate RPC calls within a request. | All personalized widgets (notifications, saved items) should hydrate via client providers/server actions to reduce blocking SSR. | Add integration tests for key flows (bookmarks, jobs admin). Monitor Supabase request counts per user; ensure logs redact PII. |
| **Jobs Marketplace (/jobs, /account/jobs/**)** | Switch `/jobs` to hybrid: static hero + deferred result grid, `revalidate = 900`. Keep `/account/jobs/**` SSR on Node. | Use `getFilteredJobs` via `fetchCached` for default feed; per-filter requests run uncached with `cache: 'no-store'`. Continue caching job detail via `cache.jobs_detail`. | Keep job alerts CTA + resume actions in client components. Offload job analytics dashboards to edge/public API if traffic spikes. | Track search/sort latency plus `pulseJobSearch` events. Add regression tests for URL param persistence. |
| **Interactive Tools & Submission Flows (/tools/config-recommender, /submit)** | Render statically where possible; wrap dynamic forms in client components. Only force SSR if feature flags or auth gating is required. | For submit stats (recent contributors), rely on cached RPCs with `revalidate = cache.submission_dashboard` (900). For config recommender, keep logic client-side. | Use server actions for form submissions; keep CSP tight by avoiding inline scripts. Consider offloading heavy scoring to edge/public API if needed. | Add Playwright smoke tests covering quiz + submission flows. Monitor form error rates and flux-station webhook success. |
| **API Routes & Edge Functions (/api/*, apps/edge/**)** | Explicitly set runtimes (`runtime = 'nodejs'` for Supabase clients; `runtime = 'edge'` when serving OG images). Mirror TTL headers with cache-config values. | Reuse `fetchCached` where applicable (templates/stats). For edge functions, leverage shared-runtime utilities and respect secret requirements. | Treat edge handlers as external APIs; web app should call them via fetch/server actions rather than imports. Offload heavy work (notifications, queue workers) to flux-station. | Enable structured logging (include cache tags, durations). Add synthetics pinging `/api/stats/social-proof` and edge OG routes. Monitor queue depth for pgmq workers. |

**Implementation cadence:**

1. **Batch static conversions.** Start with marketing routes—remove `dynamic`, add `revalidate`, confirm `pnpm --filter web build` lists them as prerendered.
2. **Adopt PPR where Suspense already exists.** Home, detail, and jobs pages already gate heavy sections via Suspense; upgrading to Next 15+ PPR simply requires segment configs.
3. **Centralize cache/flag helpers.** Provide utilities (`withCacheConfig`, `withFlags`) so new routes can adopt the blueprint without re-reading this doc.
4. **Automate verification.** Add CI checks for `runtime` declarations (account routes must be Node) and for accidental `featureFlags` imports in server components.

These playbooks ensure future contributors can choose the right rendering mode, caching strategy, and client/server boundary without redoing the foundational analysis.

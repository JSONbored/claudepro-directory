import { writeFileSync } from 'node:fs';
import { join } from 'node:path';
import { fileURLToPath } from 'node:url';
import ora from 'ora';
import { ensureEnvVars } from '../toolkit/env.js';
import { getDatabaseMeta } from '../toolkit/introspection.js';
import { logger } from '../toolkit/logger.js';
import { mapPostgresTypeToZod } from '../toolkit/zod-mapper.js';

const __filename = fileURLToPath(import.meta.url);
const SCRIPT_DIR = join(__filename, '..');
const PROJECT_ROOT = join(SCRIPT_DIR, '../../../../');
const OUTPUT_FILE = join(PROJECT_ROOT, 'packages/shared-runtime/src/schemas/database.generated.ts');

export async function runGenerateZodSchemas(targetTables?: string[]) {
  const spinner = ora('Generating Zod Schemas...').start();

  try {
    await ensureEnvVars(['POSTGRES_URL_NON_POOLING']);
    const dbUrl = process.env['POSTGRES_URL_NON_POOLING'];
    if (!dbUrl) {
      throw new Error('POSTGRES_URL_NON_POOLING is required');
    }

    spinner.text = 'Introspecting database...';
    const meta = getDatabaseMeta(dbUrl);

    spinner.text = 'Generating code...';

    const lines: string[] = [
      '// -----------------------------------------------------------------------------',
      '// ðŸ”’ AUTO-GENERATED - DO NOT EDIT',
      '// Generated by packages/generators/src/commands/generate-zod-schemas.ts',
      '// -----------------------------------------------------------------------------',
      '',
      "import { z } from 'zod';",
      '',
    ];

    const tablesToGenerate = targetTables
      ? Object.keys(meta.tables).filter((t) => targetTables.includes(t))
      : Object.keys(meta.tables);

    for (const tableName of tablesToGenerate) {
      const columns = meta.tables[tableName];
      if (!columns) continue;

      lines.push(`export const ${tableName}Schema = z.object({`);

      for (const col of columns) {
        const zodDef = mapPostgresTypeToZod(col, meta.enums);
        lines.push(`  ${col.name}: ${zodDef},`);
      }

      lines.push('});');
      lines.push(`export type ${tableName}Row = z.infer<typeof ${tableName}Schema>;`);
      lines.push('');
    }

    writeFileSync(OUTPUT_FILE, lines.join('\n'));

    spinner.succeed(`Generated schemas for ${tablesToGenerate.length} tables to ${OUTPUT_FILE}`);
  } catch (error) {
    spinner.fail('Failed to generate Zod schemas');
    logger.error((error as Error).message);
    process.exit(1);
  }
}

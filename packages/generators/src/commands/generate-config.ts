import fs from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import { createServiceRoleClient } from '../toolkit/supabase.js';

const SCRIPT_DIR = path.dirname(fileURLToPath(import.meta.url));
const REPO_ROOT = path.resolve(SCRIPT_DIR, '../../../..');
const TARGET_CONFIG_PATH = path.resolve(
  REPO_ROOT,
  'packages/web-runtime/src/config/generated-config.ts'
);

async function generateConfig() {
  console.log('ğŸ—ï¸ Fetching build-time configuration from Supabase...');

  try {
    // Use the shared service role client which handles fallbacks and standard env vars
    // like other generator scripts (e.g. generate-category-config.ts).
    // This uses SUPABASE_SERVICE_ROLE_KEY and falls back to DEFAULT_SUPABASE_URL if needed.
    const supabase = createServiceRoleClient();

    const { data, error } = await supabase.rpc('get_all_app_settings');

    if (error) {
      throw new Error(`Failed to fetch settings: ${error.message}`);
    }

    if (!data) {
      console.warn('âš ï¸ No settings returned from get_all_app_settings RPC.');
      return;
    }

    const configContent = `// --------------------------------------------------------------------------
// âš ï¸ THIS IS A GENERATED FILE. DO NOT EDIT MANUALLY.
// âš ï¸ Generated by packages/generators/src/commands/generate-config.ts at build time.
// âš ï¸ To update, change values in the 'app_settings' database table and rebuild.
// --------------------------------------------------------------------------

export const GENERATED_CONFIG = ${JSON.stringify(data, null, 2)} as const;

export type GeneratedConfig = typeof GENERATED_CONFIG;
`;

    await fs.writeFile(TARGET_CONFIG_PATH, configContent, 'utf-8');
    console.log(`âœ… Configuration generated successfully at: ${TARGET_CONFIG_PATH}`);
  } catch (err) {
    console.error('âŒ Error generating config:', err);
    process.exit(1);
  }
}

generateConfig().catch((err) => {
  console.error('âŒ Unhandled error:', err);
  process.exit(1);
});

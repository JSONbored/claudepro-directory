import fs from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import { createClient } from '@supabase/supabase-js';
import { ensureEnvVars } from '../toolkit/env.js';

const SCRIPT_DIR = path.dirname(fileURLToPath(import.meta.url));
const REPO_ROOT = path.resolve(SCRIPT_DIR, '../../../..');
const TARGET_CONFIG_PATH = path.resolve(
  REPO_ROOT,
  'packages/web-runtime/src/config/generated-config.ts'
);

async function generateConfig() {
  console.log('ğŸ—ï¸ Fetching build-time configuration from Supabase...');

  try {
    await ensureEnvVars(['NEXT_PUBLIC_SUPABASE_URL', 'NEXT_PUBLIC_SUPABASE_ANON_KEY']);

    const SUPABASE_URL = process.env['NEXT_PUBLIC_SUPABASE_URL'];
    const SUPABASE_ANON_KEY = process.env['NEXT_PUBLIC_SUPABASE_ANON_KEY'];

    if (!(SUPABASE_URL && SUPABASE_ANON_KEY)) {
      throw new Error('Missing required environment variables');
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const { data, error } = await supabase.rpc('get_all_app_settings');

    if (error) {
      throw new Error(`Failed to fetch settings: ${error.message}`);
    }

    if (!data) {
      console.warn('âš ï¸ No settings returned from get_all_app_settings RPC.');
      return;
    }

    const configContent = `// --------------------------------------------------------------------------
// âš ï¸ THIS IS A GENERATED FILE. DO NOT EDIT MANUALLY.
// âš ï¸ Generated by packages/generators/src/commands/generate-config.ts at build time.
// âš ï¸ To update, change values in the 'app_settings' database table and rebuild.
// --------------------------------------------------------------------------

export const GENERATED_CONFIG = ${JSON.stringify(data, null, 2)} as const;

export type GeneratedConfig = typeof GENERATED_CONFIG;
`;

    await fs.writeFile(TARGET_CONFIG_PATH, configContent, 'utf-8');
    console.log(`âœ… Configuration generated successfully at: ${TARGET_CONFIG_PATH}`);
  } catch (err) {
    console.error('âŒ Error generating config:', err);
    process.exit(1);
  }
}

generateConfig().catch((err) => {
  console.error('âŒ Unhandled error:', err);
  process.exit(1);
});

'use server';

// -----------------------------------------------------------------------------
// ðŸ”’ AUTO-GENERATED - DO NOT EDIT
// Generated by packages/generators/src/commands/generate-server-actions.ts
// -----------------------------------------------------------------------------

import { z } from 'zod';
import { authedAction } from './safe-action';
import { runRpc } from './run-rpc-instance';
import type { Database } from '@heyclaude/database-types';

const submitContactFormSchema = z.object({
  name: z.string(),
  email: z.string(),
  category: z.enum(['bug', 'feature', 'partnership', 'general', 'other']),
  message: z.string(),
  metadata: z.any().optional()
});

export const submitContactForm = authedAction
  .metadata({ actionName: 'submitContactForm', category: 'form' })
  .inputSchema(submitContactFormSchema)
  .action(async ({ parsedInput, ctx }) => {
    try {
      const rawResult = await runRpc<Database['public']['Functions']['insert_contact_submission']['Returns']>(
        'insert_contact_submission',
        {
          'p_name': parsedInput.name,
          'p_email': parsedInput.email,
          'p_category': parsedInput.category,
          'p_message': parsedInput.message,
          'p_metadata': parsedInput.metadata
        },
        {
          action: 'submitContactForm.rpc',
          userId: ctx.userId,
        }
      );

      
      const result = (Array.isArray(rawResult) ? rawResult[0] : rawResult) as Database['public']['Functions']['insert_contact_submission']['Returns'] extends (infer U)[] ? U : Database['public']['Functions']['insert_contact_submission']['Returns'];
      
      
      // Lazy import server-only dependencies
      const { revalidatePath, revalidateTag } = await import('next/cache');

      // Simple success check?
      // Some RPCs return void, some return { success: boolean }?
      // We assume implicit success if no error thrown by runRpc.
      
      revalidatePath(`/admin/contact-submissions`);
      revalidateTag(`contact-submission-${result?.submission_id}`, 'default');
      revalidateTag(`contact`, 'default');
      revalidateTag(`submissions`, 'default');

      
      // Lazy load hook to avoid server-only side effects at top level
      const { onContactSubmission } = await import('./hooks/contact-hooks.ts');
      const hookResult = await onContactSubmission(result, ctx, parsedInput);
      if (hookResult) {
        return hookResult;
      }
    

      return result;
    } catch (error) {
      // Lazy import logActionFailure
      const { logActionFailure } = await import('../errors');
      throw logActionFailure('submitContactForm', error, {
        userId: ctx.userId,
        input: parsedInput
      });
    }
  });

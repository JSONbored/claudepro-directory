'use server';

// -----------------------------------------------------------------------------
// ðŸ”’ AUTO-GENERATED - DO NOT EDIT
// Generated by packages/generators/src/commands/generate-server-actions.ts
// -----------------------------------------------------------------------------

import { z } from 'zod';
import { authedAction } from './safe-action';
import { runRpc } from './run-rpc-instance';
import type { Database } from '@heyclaude/database-types';

const updateReviewSchema = z.object({
  review_id: z.string().uuid().nullable().optional(),
  rating: z.number().nullable().optional(),
  review_text: z.string().nullable().optional()
});
export type UpdateReviewInput = z.infer<typeof updateReviewSchema>;

export const updateReview = authedAction
  .metadata({ actionName: 'updateReview', category: 'user' })
  .inputSchema(updateReviewSchema)
  .action(async ({ parsedInput, ctx }) => {
    try {
      const rawResult = await runRpc<Database['public']['Functions']['manage_review']['Returns']>(
        'manage_review',
        {
          'p_action': 'update',
          'p_user_id': ctx.userId,
          'p_create_data': null,
          'p_update_data': {
            'review_id': parsedInput.review_id,
            'rating': parsedInput.rating,
            'review_text': parsedInput.review_text
          },
          'p_delete_id': null
        },
        {
          action: 'updateReview.rpc',
          userId: ctx.userId,
        }
      );

      
      const result = rawResult;
      
      
      // Lazy import server-only dependencies
      // const { logActionFailure } = await import('../errors');
      const { revalidatePath, revalidateTag } = await import('next/cache');
      
      const { nextInvalidateByKeys } = await import('../cache-tags');
      const { getCacheConfigSnapshot } = await import('../cache-config');

      // Simple success check?
      // Some RPCs return void, some return { success: boolean }?
      // We assume implicit success if no error thrown by runRpc.
      
      revalidatePath(`/${result?.review?.content_type}/${result?.review?.content_slug}`);
      revalidatePath(`/${result?.review?.content_type}`);
      revalidateTag(`reviews:${result?.review?.content_type}:${result?.review?.content_slug}`, 'default');
      
      await nextInvalidateByKeys({
        cacheConfigPromise: getCacheConfigSnapshot(),
        invalidateKeys: ['cache.invalidate.review_update']
      });

      

      return result;
    } catch (error) {
      // Lazy import logActionFailure
      const { logActionFailure } = await import('../errors');
      throw logActionFailure('updateReview', error, {
        userId: ctx.userId,
        input: parsedInput
      });
    }
  });

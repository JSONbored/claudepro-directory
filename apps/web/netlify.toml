# Netlify Configuration
# Documentation: https://docs.netlify.com/configure-builds/file-based-configuration/
# Next.js Plugin: https://docs.netlify.com/frameworks/next-js/overview/

[build]
  # Monorepo configuration
  # Base directory: empty (root) - where dependencies are installed and build runs
  # This is the default, but explicitly set to override incorrect UI setting
  # UI incorrectly had "dir": "apps/web/.next" which prevented builds from starting
  base = ""
  
  # Package directory: where site files are located (including this netlify.toml)
  # For monorepos, this is the subdirectory containing your site
  package = "apps/web"
  
  # Build command - runs in the base directory (root)
  # Uses Turbo to build only the web app from the monorepo
  command = "turbo run build --filter web"
  
  # Publish directory - Next.js output directory
  # Path is relative to base directory (root)
  # Next.js plugin handles this automatically, but we specify for clarity
  publish = "apps/web/.next"

# Build environment variables
[build.environment]
  # Node.js version (matches package.json engines requirement)
  NODE_VERSION = "22"
  # pnpm version (matches packageManager in package.json)
  # Corepack will use this version from package.json automatically
  PNPM_VERSION = "10.25.0"
  # Enable pnpm (Netlify will use pnpm when it detects pnpm-lock.yaml)
  NPM_USE_PNPM = "true"
  # pnpm flags for monorepo compatibility
  # shamefully-hoist helps with dependency resolution in monorepos
  PNPM_FLAGS = "--shamefully-hoist"
  # Next.js static generation concurrency limit
  # Reduced from default (12) to 4 to prevent database connection pool exhaustion
  # This allows more pages to be generated in the same worker, improving cache hit rates
  # after pre-fetching in generateStaticParams
  NEXT_STATIC_GENERATION_MAX_CONCURRENCY = "4"
  # CRITICAL: Disable Turbo remote cache to prevent build hangs
  # When TURBO_TOKEN/TURBO_TEAM aren't set, Turbo tries to connect to remote cache
  # and hangs indefinitely. This forces local-only cache.
  TURBO_REMOTE_CACHE_ENABLED = "false"
  # Disable Netlify Edge Functions for Next.js Middleware
  # Our middleware/proxy.ts uses Node.js-only dependencies (pino via logger) that don't work in edge runtimes.
  # Setting this to true forces middleware to use regular serverless functions instead of edge functions.
  # See: https://docs.netlify.com/build/frameworks/framework-setup-guides/nextjs/legacy-runtime/middleware
  NEXT_DISABLE_NETLIFY_EDGE = "true"

# Next.js plugin configuration
# Explicitly add the plugin (required for Next.js on Netlify)
# The plugin handles Next.js-specific optimizations, routing, and ISR
[[plugins]]
package = "@netlify/plugin-nextjs"

# Clean ISR blobs plugin - removes blobs after build to prevent 400 upload errors
# The Next.js plugin generates large ISR cache blobs that fail to upload
# Path must be absolute relative to base directory (root) for monorepos
[[plugins]]
package = "/netlify/plugins/clean-blobs"

# Inngest plugin - registers serverless Inngest functions
# Configured to use /api/inngest endpoint (default)
[[plugins]]
package = "netlify-plugin-inngest"
  [plugins.inputs]
  host = "https://claudepro.directory"
  path = "/api/inngest"

# Build cache directories for faster rebuilds
# These directories persist between builds to speed up subsequent deployments
[[cache.directories]]
  # Next.js build cache (compiled pages, chunks, etc.)
  # This is critical for faster rebuilds
  path = "apps/web/.next/cache"
[[cache.directories]]
  # Turbo build cache (monorepo build artifacts)
  # Speeds up monorepo builds by caching task outputs
  path = ".turbo"
[[cache.directories]]
  # pnpm store cache (dependency cache)
  # Speeds up dependency installation
  path = ".pnpm-store"

# Note: We intentionally do NOT cache node_modules
# Caching node_modules can cause issues with dependency resolution
# and is generally not recommended by Netlify

# Redirects and rewrites (handled by Next.js plugin automatically)
# Next.js plugin automatically configures:
# - Static file serving
# - API routes
# - Dynamic routes
# - ISR (Incremental Static Regeneration)
# - Server-side rendering
# - Image optimization

# Edge Functions (if using Netlify Edge Functions)
# Uncomment if you have edge functions to deploy
# [build.edge_functions]
#   directory = "apps/edge/functions"

# Functions configuration
# Exclude large dependencies to reduce function size (250MB limit)
[functions]
  # Exclude unnecessary Sharp platform binaries
  # Netlify Functions run on Linux x64 only, so we only need sharp-libvips-linux-x64
  # Excluding all other platform binaries saves ~130MB
  # Note: pnpm uses @img+sharp-* format in .pnpm directory
  included_files = [
    # Exclude .env files (should use Netlify UI for env vars, not bundled files)
    # These files are automatically included by Next.js plugin but shouldn't be in function bundle
    # Environment variables should be set in Netlify UI with proper scoping (Build vs Functions)
    # Use absolute paths relative to base directory (root) for monorepos
    "!apps/web/.env",
    "!apps/web/.env.local",
    "!apps/web/.env.production",
    "!apps/web/.env.production.local",
    "!.env",
    "!.env.local",
    "!.env.production",
    "!.env.production.local",
    "!**/.env",
    "!**/.env.local",
    "!**/.env.production",
    "!**/.env.production.local",
    # Exclude macOS Sharp binaries (pnpm format: @img+sharp-libvips-darwin-*)
    "!node_modules/.pnpm/@img+sharp-libvips-darwin-*/**/*",
    "!node_modules/.pnpm/@img+sharp-darwin-*/**/*",
    # Exclude Linux ARM variants
    "!node_modules/.pnpm/@img+sharp-libvips-linux-arm*/**/*",
    # Exclude Linux non-x64 architectures
    "!node_modules/.pnpm/@img+sharp-libvips-linux-ppc64*/**/*",
    "!node_modules/.pnpm/@img+sharp-libvips-linux-s390x*/**/*",
    "!node_modules/.pnpm/@img+sharp-libvips-linux-riscv64*/**/*",
    # Exclude Linux musl variants
    "!node_modules/.pnpm/@img+sharp-libvips-linuxmusl-*/**/*",
    # Exclude Sharp WASM (not needed for server-side)
    "!node_modules/.pnpm/@img+sharp-wasm32*/**/*",
    # Exclude TypeScript (shouldn't be in production function bundle)
    "!node_modules/.pnpm/typescript@*/**/*",
    "!node_modules/typescript/**/*"
  ]

# Context-specific configurations
# These inherit from [build] by default, but can be overridden per context

# Production environment
# All deploys from the Production branch inherit these settings
[context.production]
  # Inherits command and publish from [build] section

# Deploy Preview environment
# All deploys from pull/merge requests inherit these settings
[context.deploy-preview]
  # Inherits command and publish from [build] section

# Branch Deploy environment
# All deploys from branches (not PRs) inherit these settings
[context.branch-deploy]
  # Inherits command and publish from [build] section

# Development environment (local dev with Netlify Dev)
[context.dev]
  # Inherits command and publish from [build] section

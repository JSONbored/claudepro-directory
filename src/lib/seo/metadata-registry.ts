/**
 * Metadata Types & Utilities
 *
 * **PATTERN-BASED ARCHITECTURE (October 2025):**
 * All metadata is now generated by the pattern system (metadata-templates.ts).
 * This file provides shared types and AI optimization utilities.
 *
 * Metadata Resolution (100% Pattern Coverage):
 * 1. **Pattern System** (Primary) - All routes use pattern-based templates
 * 2. **Smart Defaults** (Fallback) - Generic metadata for unknown routes only
 *
 * October 2025 SEO Optimization:
 * - AI citation optimization (ChatGPT, Perplexity, Claude search)
 * - Schema.org 29.3 compliance (817 types available)
 * - Server-side JSON-LD only (AI bots skip client-side JavaScript)
 * - Recency signals (dateModified within 30 days = 3.2x more citations)
 * - Year inclusion in descriptions (ChatGPT queries for current year)
 *
 * @module lib/seo/metadata-registry
 */

import { z } from 'zod';
import { APP_CONFIG } from '@/src/lib/constants';

/**
 * Metadata Source Type
 * Indicates where metadata originated from
 */
export type RouteMetadataSource = 'registry' | 'schema' | 'smart-default';

/**
 * Context type for metadata generation
 * Defined here to avoid circular imports
 *
 * Production Standards:
 * - Compatible with exactOptionalPropertyTypes: true
 * - All optional properties explicitly allow undefined
 * - Index signatures for flexibility with content loaders
 */
export interface MetadataContext {
  /** Route path (e.g., '/', '/agents', '/agents/code-reviewer') */
  route?: string | undefined;

  /** Dynamic route parameters from Next.js (e.g., { category: 'agents', slug: 'code-reviewer' }) */
  params?: Record<string, string | string[]> | undefined;

  /** Content item data (from schema adapter or page data) */
  item?:
    | {
        title?: string | undefined;
        name?: string | undefined;
        description?: string | undefined;
        tags?: string[] | undefined;
        author?: string | undefined;
        dateAdded?: string | undefined;
        lastModified?: string | undefined;
        [key: string]: unknown;
      }
    | undefined;

  /** Category configuration from UNIFIED_CATEGORY_REGISTRY */
  categoryConfig?:
    | {
        title?: string | undefined;
        pluralTitle?: string | undefined;
        metaDescription?: string | undefined;
        keywords?: string | undefined; // Comma-separated string from category-config.ts
        [key: string]: unknown;
      }
    | undefined;

  /** Category slug (e.g., 'agents', 'mcp', 'commands') */
  category?: string | undefined;

  /** Content slug (e.g., 'code-reviewer', 'filesystem-server') */
  slug?: string | undefined;

  /** User profile data (for USER_PROFILE pattern) */
  profile?: unknown | undefined;

  /** Search/filter parameters */
  filters?: Record<string, unknown> | undefined;

  /** Index signature for additional dynamic properties */
  [key: string]: unknown;
}

/**
 * AI Optimization Configuration Schema
 * Flags for October 2025 AI search engine optimization
 *
 * Research-backed optimizations:
 * - Content updated within 30 days = 3.2x more AI citations
 * - Including "2025" in descriptions increases ChatGPT citation likelihood
 * - Wikipedia-style content gets 7.8% citation rate (highest of all sources)
 * - Article schema preferred over WebPage for content pages
 *
 * @see {@link file://./ai-optimization.ts} - Helper functions for AI optimization
 */
export const aiOptimizationSchema = z
  .object({
    /** Include current year in description (ChatGPT search queries for "2025") */
    includeYear: z
      .boolean()
      .default(true)
      .describe('Add current year/month to description for AI search optimization'),

    /** Add recency signal (dateModified timestamp) for 3.2x more AI citations */
    recencySignal: z
      .boolean()
      .default(false)
      .describe('Include dateModified in metadata for fresh content signals'),

    /** Use Article schema instead of WebPage (better for AI citations) */
    useArticleSchema: z
      .boolean()
      .default(false)
      .describe('Prefer Article over WebPage schema for content pages'),

    /** Generate FAQ schema for AI answer engines */
    generateFAQSchema: z
      .boolean()
      .default(false)
      .describe('Generate FAQ structured data for question-answering AI engines'),

    /** Structure content like Wikipedia (preferred by AI models - 7.8% citation rate) */
    wikipediaStyle: z
      .boolean()
      .default(false)
      .describe('Use Wikipedia-style structure (H2→H3→bullets) for higher citation rate'),
  })
  .describe('AI search engine optimization configuration for October 2025');

export type AIOptimization = z.infer<typeof aiOptimizationSchema>;

/**
 * Title Configuration
 * Titles are generated by pattern system templates (metadata-templates.ts)
 *
 * Production Standards:
 * - 53-60 chars total (2025 SEO optimization for keyword density)
 * - Hyphen separator (2025 best practice)
 * - Support for static strings or dynamic functions
 * - **PERFORMANCE**: Synchronous only - no Promise overhead
 * - Next.js 15 can optimize synchronous metadata at build time
 */
export type TitleConfig = string | ((context?: MetadataContext) => string);

/**
 * Structured Data Configuration Schema
 * Controls JSON-LD schema generation for SEO
 *
 * Production Standards:
 * - Server-side only (AI bots skip client-side JavaScript)
 * - Schema.org 29.3 compliance (September 2025 version)
 * - Article schema preferred for content pages (better AI citations)
 * - All schemas include required properties for validation
 *
 * @see {@link https://schema.org/docs/schemas.html} - Schema.org documentation
 */
export const structuredDataConfigSchema = z
  .object({
    /** Primary schema type (Article recommended for AI citations) */
    type: z
      .enum([
        'WebPage',
        'Article',
        'FAQPage',
        'HowTo',
        'SoftwareApplication',
        'JobPosting',
        'CollectionPage',
        'Blog',
        'TechArticle',
        'ProfilePage',
      ])
      .describe('Schema.org type for structured data generation'),

    /** Generate breadcrumb navigation schema */
    breadcrumbs: z.boolean().default(true).describe('Include BreadcrumbList schema for navigation'),

    /** Include dateModified for recency signals */
    dateModified: z
      .boolean()
      .default(false)
      .describe('Add dateModified property for fresh content signals (3.2x more AI citations)'),

    /** Include author information */
    author: z.boolean().default(false).describe('Include author/publisher information in schema'),
  })
  .describe('Configuration for JSON-LD structured data generation');

export type StructuredDataConfig = z.infer<typeof structuredDataConfigSchema>;

/**
 * Route Metadata Configuration
 * Defines metadata for a specific route or route pattern
 *
 * Production Standards:
 * - Type-safe function signatures with explicit MetadataContext
 * - Support for both static values and dynamic resolution
 * - AI optimization flags for October 2025 SEO
 * - Full TSDoc documentation for all properties
 *
 * @interface RouteMetadata
 */
export interface RouteMetadata {
  /**
   * Page title configuration
   * Can be static string or function for dynamic resolution
   * Generated by pattern system templates (metadata-templates.ts)
   *
   * @example
   * ```typescript
   * // Static
   * title: 'Community - Claude Pro Directory'
   *
   * // Dynamic
   * title: (context) => `${context?.item?.title} - ${APP_CONFIG.name}`
   * ```
   */
  title: TitleConfig;

  /**
   * Meta description (120-160 chars for AI optimization)
   * AI-optimized length based on October 2025 research
   * Can be static string or function for dynamic resolution
   *
   * **PERFORMANCE**: Synchronous only - no Promise overhead
   */
  description: string | ((context?: MetadataContext) => string);

  /**
   * Keywords array (max 10 for SEO best practice)
   * Optional - only used for specific content types
   * Can be static array or function for dynamic resolution
   *
   * **PERFORMANCE**: Synchronous only - no Promise overhead
   */
  keywords?: string[] | ((context?: MetadataContext) => string[]);

  /**
   * OpenGraph configuration (REQUIRED for all routes)
   * Used for social media sharing previews
   * Title and description default to page title/description if not specified
   */
  openGraph: {
    title?: string | undefined;
    description?: string | undefined;
    type: 'website' | 'article';
  };

  /**
   * Twitter Card configuration (REQUIRED for all routes)
   * Used for Twitter/X sharing previews
   * Title and description default to page title/description if not specified
   */
  twitter: {
    title?: string | undefined;
    description?: string | undefined;
    card: 'summary' | 'summary_large_image';
  };

  /**
   * Structured data configuration
   * Controls JSON-LD schema generation for SEO
   */
  structuredData: StructuredDataConfig;

  /**
   * AI optimization flags
   * October 2025 settings for ChatGPT, Perplexity, Claude search
   */
  aiOptimization?: AIOptimization;

  /**
   * Robots meta directives (optional)
   * Controls search engine crawler behavior
   * Defaults to index: true, follow: true if not specified
   */
  robots?: {
    index: boolean;
    follow: boolean;
  };
}

/**
 * Global Metadata Defaults
 * Applied to all routes unless overridden
 */
export const METADATA_DEFAULTS = {
  siteName: APP_CONFIG.name,
  separator: ' - ',
  includeYear: true,
  serverSideOnly: true, // No client-side JSON-LD (AI bots skip JavaScript)
  schemaVersion: '29.3', // Schema.org version (Sept 4, 2025)
} as const;

// ============================================
// AI SEARCH OPTIMIZATION UTILITIES
// ============================================
// Consolidated from ai-optimization.ts for tree-shaking
// October 2025 AI citation optimization for ChatGPT, Perplexity, Claude

/**
 * Get current year for AI search optimization
 * ChatGPT often includes the current year when issuing Bing queries
 */
export function getCurrentYear(): string {
  return new Date().getFullYear().toString();
}

/**
 * Get current month and year (e.g., "October 2025")
 * Useful for seasonal/time-sensitive content
 */
export function getCurrentMonthYear(): string {
  const date = new Date();
  const month = date.toLocaleString('en-US', { month: 'long' });
  const year = date.getFullYear();
  return `${month} ${year}`;
}

/**
 * Add year to description for AI citation optimization
 * Research: Including current year increases ChatGPT citation likelihood
 *
 * @example
 * addYearToDescription("Browse Claude AI tools")
 * // → "Browse Claude AI tools. Updated October 2025."
 */
export function addYearToDescription(
  description: string,
  options: {
    fullDate?: boolean;
    position?: 'end' | 'beginning';
  } = {}
): string {
  const { fullDate = true, position = 'end' } = options;
  const yearText = fullDate ? getCurrentMonthYear() : getCurrentYear();

  // Don't add if already contains year
  if (description.includes(yearText) || description.includes(getCurrentYear())) {
    return description;
  }

  if (position === 'beginning') {
    return `${yearText}: ${description}`;
  }

  // Add year at end naturally
  const endsWithPeriod = description.trim().endsWith('.');
  const separator = endsWithPeriod ? '' : '.';
  return `${description.trim()}${separator} Updated ${yearText}.`;
}

/**
 * Check if content is fresh (updated within 30 days)
 * Research: Fresh content gets 3.2x more AI citations
 */
export function isContentFresh(dateString: string | Date): boolean {
  try {
    const date = typeof dateString === 'string' ? new Date(dateString) : dateString;
    const now = new Date();
    const daysDiff = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24));
    return daysDiff <= 30;
  } catch {
    return false;
  }
}

/**
 * Generate recency signal for metadata
 * Returns ISO timestamp if content is fresh, undefined otherwise
 */
export function getRecencySignal(lastModified?: string): string | undefined {
  if (!lastModified) return undefined;
  return isContentFresh(lastModified) ? lastModified : undefined;
}

/**
 * Optimize keywords for AI search
 * Adds current year and common LLM search patterns
 *
 * @example
 * optimizeKeywordsForAI(['claude ai', 'mcp servers'])
 * // → ['claude ai', 'mcp servers', 'claude ai 2025', 'mcp servers 2025', 'ai tools 2025']
 */
export function optimizeKeywordsForAI(
  baseKeywords: string[],
  options: {
    addYear?: boolean;
    addAITools?: boolean;
    maxKeywords?: number;
  } = {}
): string[] {
  const { addYear = true, addAITools = true, maxKeywords = 10 } = options;
  const year = getCurrentYear();
  const optimized = [...baseKeywords];

  if (addYear) {
    const topKeywords = baseKeywords.slice(0, 3);
    for (const keyword of topKeywords) {
      if (!keyword.includes(year)) {
        optimized.push(`${keyword} ${year}`);
      }
    }
  }

  if (addAITools && !baseKeywords.some((k) => k.includes('ai tools'))) {
    optimized.push(`ai tools ${year}`);
  }

  return optimized.slice(0, maxKeywords);
}

/**
 * Calculate content freshness score
 * Used to prioritize fresh content in search results
 * @returns Freshness score (0-100, higher = fresher)
 */
export function calculateFreshnessScore(lastModified: string | Date): number {
  try {
    const date = typeof lastModified === 'string' ? new Date(lastModified) : lastModified;
    const now = new Date();
    const daysSinceUpdate = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24));

    // Scoring: 100 (today) → 50 (30 days) → 0 (90+ days)
    if (daysSinceUpdate <= 0) return 100;
    if (daysSinceUpdate <= 30) return 100 - Math.floor((daysSinceUpdate / 30) * 50);
    if (daysSinceUpdate <= 90) return 50 - Math.floor(((daysSinceUpdate - 30) / 60) * 50);
    return 0;
  } catch {
    return 0;
  }
}

/**
 * Generate AI-optimized meta description
 * Combines best practices from Google SEO + AI citation research
 * @returns Optimized description (120-160 chars)
 */
export function optimizeDescriptionForAI(
  base: string,
  options: {
    includeYear?: boolean;
    targetLength?: number;
    addCTA?: boolean;
  } = {}
): string {
  const { includeYear = true, targetLength = 150, addCTA = false } = options;
  let description = base.trim();

  // Add year if requested and not already present
  if (includeYear && !description.includes(getCurrentYear())) {
    const year = getCurrentMonthYear();
    if (description.length + year.length + 4 <= targetLength) {
      description = `${description} in ${year}`;
    }
  }

  // Add CTA if requested and space allows
  if (addCTA && description.length + 15 <= targetLength) {
    description = `${description}. Browse now.`;
  }

  // Truncate if too long (preserve sentence structure)
  if (description.length > targetLength) {
    const truncated = description.substring(0, targetLength - 3);
    const lastPeriod = truncated.lastIndexOf('.');
    const lastSpace = truncated.lastIndexOf(' ');

    if (lastPeriod > targetLength * 0.8) {
      description = truncated.substring(0, lastPeriod + 1);
    } else if (lastSpace > targetLength * 0.9) {
      description = `${truncated.substring(0, lastSpace)}...`;
    } else {
      description = `${truncated}...`;
    }
  }

  return description;
}

// ============================================
// AI OPTIMIZATION ORCHESTRATOR
// ============================================

/**
 * Apply AI optimization to metadata
 * Central orchestrator for all AI search engine optimizations
 *
 * @param metadata - Metadata object to optimize
 * @param options - AI optimization configuration
 * @param context - Optional context (item, category, etc.)
 * @returns Optimized metadata
 */
export interface MetadataToOptimize {
  title?: string;
  description?: string;
  keywords?: string[] | undefined; // Compatible with exactOptionalPropertyTypes: true
  lastModified?: string;
  [key: string]: unknown;
}

export function applyAIOptimization(
  metadata: MetadataToOptimize,
  options: AIOptimization,
  context?: MetadataContext
): MetadataToOptimize {
  const optimized = { ...metadata };

  // 1. Optimize description with year
  if (options.includeYear && optimized.description) {
    optimized.description = optimizeDescriptionForAI(optimized.description, {
      includeYear: true,
      targetLength: 155,
      addCTA: false,
    });
  }

  // 2. Optimize keywords with year variants
  if (optimized.keywords && Array.isArray(optimized.keywords)) {
    optimized.keywords = optimizeKeywordsForAI(optimized.keywords, {
      addYear: options.includeYear,
      addAITools: true,
      maxKeywords: 10,
    });
  }

  // 3. Add recency signal if content is fresh
  if (options.recencySignal && context?.item?.lastModified) {
    const recencySignal = getRecencySignal(context.item.lastModified);
    if (recencySignal) {
      optimized.lastModified = recencySignal;
    }
  }

  return optimized;
}

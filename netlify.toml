# Netlify Configuration
# Documentation: https://docs.netlify.com/configure-builds/file-based-configuration/
# Next.js Plugin: https://docs.netlify.com/frameworks/next-js/overview/

[build]
  # Monorepo configuration: package directory points to the app subdirectory
  # Base directory is unset to use repository root (default)
  package = "apps/web"
  # Build command - uses Turbo to build the web app
  command = "turbo run build --filter web"
  # Publish directory - Next.js plugin handles this automatically, but we specify for clarity
  # The plugin will use .next directory for Next.js SSR/hybrid builds
  publish = "apps/web/.next"

# Build environment variables
[build.environment]
  # Node.js version (matches package.json engines requirement)
  NODE_VERSION = "22"
  # pnpm version (matches packageManager in package.json)
  # Corepack will use this version from package.json automatically
  PNPM_VERSION = "10.25.0"
  # Enable pnpm (Netlify will use pnpm when it detects pnpm-lock.yaml)
  NPM_USE_PNPM = "true"
  # pnpm flags for monorepo compatibility
  # shamefully-hoist helps with dependency resolution in monorepos
  PNPM_FLAGS = "--shamefully-hoist"
  # Next.js static generation concurrency limit
  # Reduced from default (12) to 4 to prevent database connection pool exhaustion
  # This allows more pages to be generated in the same worker, improving cache hit rates
  # after pre-fetching in generateStaticParams
  NEXT_STATIC_GENERATION_MAX_CONCURRENCY = "4"

# Next.js plugin configuration
# Explicitly add the plugin (required for Next.js on Netlify)
# The plugin handles Next.js-specific optimizations, routing, and ISR
[[plugins]]
package = "@netlify/plugin-nextjs"

# Build cache directories for faster rebuilds
# These directories persist between builds to speed up subsequent deployments
[[cache.directories]]
  # Next.js build cache (compiled pages, chunks, etc.)
  # This is critical for faster rebuilds
  path = "apps/web/.next/cache"
[[cache.directories]]
  # Turbo build cache (monorepo build artifacts)
  # Speeds up monorepo builds by caching task outputs
  path = ".turbo"
[[cache.directories]]
  # pnpm store cache (dependency cache)
  # Speeds up dependency installation
  path = ".pnpm-store"

# Note: We intentionally do NOT cache node_modules
# Caching node_modules can cause issues with dependency resolution
# and is generally not recommended by Netlify

# Redirects and rewrites (handled by Next.js plugin automatically)
# Next.js plugin automatically configures:
# - Static file serving
# - API routes
# - Dynamic routes
# - ISR (Incremental Static Regeneration)
# - Server-side rendering
# - Image optimization

# Edge Functions (if using Netlify Edge Functions)
# Uncomment if you have edge functions to deploy
# [build.edge_functions]
#   directory = "apps/edge/functions"

# Functions (if using Netlify Functions)
# Uncomment if you have serverless functions to deploy
# [build.functions]
#   directory = "netlify/functions"

# Context-specific configurations
# These inherit from [build] by default, but can be overridden per context

# Production environment
# All deploys from the Production branch inherit these settings
[context.production]
  # Inherits command and publish from [build] section

# Deploy Preview environment
# All deploys from pull/merge requests inherit these settings
[context.deploy-preview]
  # Inherits command and publish from [build] section

# Branch Deploy environment
# All deploys from branches (not PRs) inherit these settings
[context.branch-deploy]
  # Inherits command and publish from [build] section

# Development environment (local dev with Netlify Dev)
[context.dev]
  # Inherits command and publish from [build] section

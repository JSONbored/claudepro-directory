/**
 * Netlify Build Plugin: Clean ISR Blobs
 * 
 * This plugin removes ISR cache blobs generated by @netlify/plugin-nextjs
 * to prevent 400 errors during blob upload.
 * 
 * The Next.js plugin generates large ISR cache blobs (~736MB, 341 files)
 * that fail to upload with 400 errors. This plugin cleans them after
 * the build completes but before Netlify tries to upload them.
 */

import { rm, readdir } from 'fs/promises';
import { join } from 'path';
import { existsSync } from 'fs';

export default {
  onPostBuild: async ({ constants, utils }) => {
    // Blobs are generated by Next.js plugin in the package directory
    // For monorepos: base = "" (root), package = "apps/web"
    // Blobs are at: apps/web/.netlify/deploy/v1/blobs/deploy
    // We need to construct path relative to base directory (root)
    const { BUILD_DIR } = constants;
    // BUILD_DIR is the base directory (root in our case)
    // Package directory is apps/web, so blobs are at apps/web/.netlify/...
    const blobDir = join(BUILD_DIR || process.cwd(), 'apps', 'web', '.netlify', 'deploy', 'v1', 'blobs', 'deploy');
    
    try {
      // Check if directory exists
      if (existsSync(blobDir)) {
        // Remove all blob files
        const files = await readdir(blobDir);
        
        if (files.length > 0) {
          console.log(`Cleaning ${files.length} ISR cache blobs to prevent upload errors...`);
          
          // Remove all files in the blob directory
          for (const file of files) {
            const filePath = join(blobDir, file);
            await rm(filePath, { recursive: true, force: true });
          }
          
          console.log(`Cleaned ${files.length} blob files successfully`);
        }
      }
    } catch (error) {
      // Log but don't fail the build if cleanup fails
      console.warn(`Warning: Failed to clean blobs: ${error.message}`);
    }
  },
};

# Lefthook Configuration - Claude Pro Directory
# Version: 3.0.0 (November 2025)
# Enhanced with auto-format, edge function type-check, and tech debt tracking

# ============================================================================
# OUTPUT CONTROL
# ============================================================================
output:
  - execution      # Show what's running
  - execution_out  # Show command output
  - skips         # Show skipped commands
  - failure       # Always show failures

# ============================================================================
# PRE-COMMIT: Fast checks on staged files only
# Runs in parallel for speed, fails fast on critical issues
# ============================================================================
pre-commit:
  parallel: true
  follow: true
  commands:
    # 1. Type checking (Next.js/Node code - build dirs only)
    type-check:
      glob: "**/*.{ts,tsx}"
      exclude: 
        - "apps/edge/functions/**"
        - "packages/edge-runtime/src/utils/email/**"
      run: |
        echo "üîç Type checking build-critical code..."
        pnpm type-check:build
      fail_text: "‚ùå Type errors found in build-critical code. Fix them before committing."

    # 2. Type checking (Edge functions - Deno)
    type-check-edge:
      glob: "apps/edge/functions/**/*.ts"
      run: |
        echo "ü¶ï Type checking edge functions..."
        if command -v deno &> /dev/null; then
          set +e
          OUTPUT=$(pnpm type-check:edge 2>&1)
          STATUS=$?
          echo "$OUTPUT"
          if [ $STATUS -ne 0 ]; then
            if echo "$OUTPUT" | grep -F "packages/edge-runtime/src/utils/email/" >/dev/null; then
              echo "‚ö†Ô∏è  Email template type errors detected but ignored (packages/edge-runtime/src/utils/email/**)."
              exit 0
            fi
            exit $STATUS
          fi
        else
          echo "‚ö†Ô∏è  Deno not installed - skipping edge function type-check"
          echo "   Install: brew install deno"
        fi
      fail_text: "‚ùå Type errors found in edge functions. Fix them before committing."

    # 3. Lint and auto-fix with ESLint (build dirs only, non-blocking)
    lint:
      glob: "**/*.{ts,tsx}"
      exclude: 
        - "apps/edge/functions/**"
        - "packages/edge-runtime/src/utils/email/**"
      run: |
        echo "üîç Linting build-critical code (non-blocking)..."
        set +e
        pnpm lint:build --fix
        LINT_STATUS=$?
        git add -u
        if [ $LINT_STATUS -ne 0 ]; then
          echo "‚ö†Ô∏è  ESLint found errors in build-critical code (not blocking - fix before merging)"
          echo "   Run 'pnpm lint:build' to see full output"
        else
          echo "‚úÖ Linting passed"
        fi
        exit 0
      fail_text: "‚ö†Ô∏è  ESLint found errors (not blocking - fix before merging)."
      stage_fixed: true

    # 4. Validate client/server boundaries (catches build-time import issues)
    validate-client-server:
      glob: "apps/web/src/**/*.{ts,tsx}"
      run: |
        echo "üîç Validating client/server boundaries..."
        pnpm validate:client-server
      fail_text: "‚ùå Client/server boundary violations found. Fix them before committing."

    # 6. Validate MCP tools (if MCP files changed)
    validate-mcp-tools:
      glob: "apps/edge/supabase/functions/heyclaude-mcp/**/*.ts"
      run: |
        echo "üîç Validating MCP tools..."
        pnpm validate:mcp-tools
      fail_text: "‚ùå MCP tool validation failed. Fix errors before committing."

    # 7. Validate Zod schemas (if MCP types changed)
    validate-zod-schemas:
      glob: "apps/edge/supabase/functions/heyclaude-mcp/lib/types.ts"
      run: |
        echo "üîç Validating Zod schemas..."
        pnpm validate:zod-schemas
      fail_text: "‚ùå Zod schema validation failed. Fix errors before committing."

    # 8. Validate API routes (if API routes changed)
    validate-api-routes:
      glob: "apps/web/src/app/api/**/route.ts"
      run: |
        echo "üîç Validating API routes..."
        pnpm validate:api-routes
      fail_text: "‚ùå API route validation failed. Fix errors before committing."

    # 9. Validate client/server boundaries (if components changed)
    validate-boundaries:
      glob: "apps/web/src/**/*.{tsx,ts}"
      exclude:
        - "apps/web/src/app/**"  # App router pages are server components by default
      run: |
        echo "üîç Validating client/server boundaries..."
        pnpm validate:boundaries
      fail_text: "‚ùå Client/server boundary validation failed. Fix errors before committing."

    # 10. Validate server actions (if actions changed)
    validate-server-actions:
      glob: "packages/web-runtime/src/actions/**/*.ts"
      run: |
        echo "üîç Validating server actions..."
        pnpm validate:server-actions
      fail_text: "‚ùå Server action validation failed. Fix errors before committing."

    # 11. Validate database queries (if data layer or app code changed)
    validate-database-queries:
      glob: "apps/web/src/**/*.{ts,tsx}"
      exclude:
        - "apps/web/src/components/**"  # Components shouldn't have direct queries
      run: |
        echo "üîç Validating database queries..."
        pnpm validate:database-queries
      fail_text: "‚ùå Database query validation failed. Fix errors before committing."

    # 12. Validate authentication checks (if API routes or actions changed)
    validate-authentication:
      glob: "apps/web/src/app/api/**/*.{ts,tsx}"
      run: |
        echo "üîç Validating authentication checks..."
        pnpm validate:authentication
      fail_text: "‚ùå Authentication validation failed. Fix errors before committing."

    # 13. Validate RLS policies (if migrations changed)
    validate-rls-policies:
      glob: "supabase/migrations/**/*.sql"
      run: |
        echo "üîç Validating RLS policies..."
        pnpm validate:rls-policies
      fail_text: "‚ùå RLS policy validation failed. Fix errors before committing."

    # 14. Validate Cache Components (if pages or API routes changed)
    validate-cache-components:
      glob: "apps/web/src/app/**/*.{tsx,ts}"
      run: |
        echo "üîç Validating Cache Components usage..."
        pnpm validate:cache-components
      fail_text: "‚ùå Cache Components validation failed. Fix errors before committing."

    # 15. Validate NextResponse promise handling (if API routes changed)
    validate-nextresponse-promises:
      glob: "apps/web/src/app/api/**/*.{ts,tsx}"
      run: |
        echo "üîç Validating NextResponse promise handling..."
        pnpm validate:nextresponse-promises
      fail_text: "‚ùå NextResponse promise validation failed. Fix errors before committing."

    # 16. Validate server component error handling (if pages changed)
    validate-server-component-errors:
      glob: "apps/web/src/app/**/page.{tsx,ts}"
      run: |
        echo "üîç Validating server component error handling..."
        pnpm validate:server-component-errors
      fail_text: "‚ùå Server component error handling validation failed. Fix errors before committing."

    # 17. Validate client component error handling (if components changed)
    validate-client-component-errors:
      glob: "apps/web/src/components/**/*.{tsx,ts}"
      run: |
        echo "üîç Validating client component error handling..."
        pnpm validate:client-component-errors
      fail_text: "‚ùå Client component error handling validation failed. Fix errors before committing."

    # 18. Validate logging context (if pages/routes/components changed)
    validate-logging-context:
      glob: "apps/web/src/app/**/*.{tsx,ts} apps/web/src/components/**/*.{tsx,ts}"
      run: |
        echo "üîç Validating logging context and request ID usage..."
        pnpm validate:logging-context
      fail_text: "‚ùå Logging context validation failed. Fix errors before committing."

    # 7. Run tests for changed files (non-blocking, warnings only)
    test-affected:
      glob: "**/*.{ts,tsx}"
      exclude: 
        - "apps/edge/functions/**"
        - "packages/edge-runtime/src/utils/email/**"
      run: |
        echo "üß™ Running tests for changed files (non-blocking)..."
        set +e
        # Run only tests related to changed files (vitest --changed)
        # This is fast and only runs tests that might be affected by changes
        pnpm test --run --changed 2>&1
        TEST_STATUS=$?
        if [ $TEST_STATUS -ne 0 ]; then
          echo "‚ö†Ô∏è  Tests failed for changed files, trying all tests..."
          pnpm test --run 2>&1
          ALL_TEST_STATUS=$?
          if [ $ALL_TEST_STATUS -ne 0 ]; then
            echo "‚ö†Ô∏è  Some tests failed (not blocking - fix before merging)"
            echo "   Run 'pnpm test' to see full output"
          else
            echo "‚úÖ All tests passed"
          fi
        else
          echo "‚úÖ Tests for changed files passed"
        fi
        exit 0
      fail_text: "‚ö†Ô∏è  Tests failed (not blocking - fix before merging)."
      stage_fixed: false

# ============================================================================
# PRE-PUSH: Comprehensive checks before code reaches remote
# ============================================================================
pre-push:
  parallel: false
  commands:
    # 1. Type checking (build-critical code only)
    # Note: Only checks code that affects production build
    type-check-all:
      run: |
        echo "üîç Type checking build-critical code..."
        set +e
        OUTPUT=$(pnpm type-check:build 2>&1)
        STATUS=$?
        echo "$OUTPUT"
        if [ $STATUS -ne 0 ]; then
          if echo "$OUTPUT" | grep -F "packages/edge-runtime/src/utils/email/" >/dev/null; then
            echo "‚ö†Ô∏è  Email template type errors detected but ignored (packages/edge-runtime/src/utils/email/**)."
            exit 0
          fi
          exit $STATUS
        fi
      fail_text: "‚ùå Type errors found in build-critical code. Fix them before pushing."

    # 2. Lint check (non-blocking, warnings only)
    lint-all:
      run: |
        echo "üîç Running full lint check (non-blocking)..."
        set +e
        pnpm lint:build 2>&1
        LINT_STATUS=$?
        if [ $LINT_STATUS -ne 0 ]; then
          echo "‚ö†Ô∏è  ESLint found errors (not blocking - fix before merging)"
          echo "   Run 'pnpm lint:build' to see full output"
        else
          echo "‚úÖ Linting passed"
        fi
        exit 0
      fail_text: "‚ö†Ô∏è  ESLint found errors (not blocking - fix before merging)."

    # 3. Validate MCP tools and schemas (comprehensive check)
    validate-mcp-all:
      run: |
        echo "üîç Validating MCP tools and schemas..."
        pnpm validate:mcp
      fail_text: "‚ùå MCP validation failed. Fix errors before pushing."

    # 4. Analyze dependencies (non-blocking warnings)
    analyze-dependencies:
      run: |
        echo "üîç Analyzing dependencies..."
        pnpm analyze:dependencies
      fail_text: "‚ö†Ô∏è  Dependency issues found (not blocking - fix iteratively)."

    # 5. Validate API routes (comprehensive check)
    validate-api-routes-all:
      run: |
        echo "üîç Validating all API routes..."
        pnpm validate:api-routes
      fail_text: "‚ùå API route validation failed. Fix errors before pushing."

    # 6. Validate client/server boundaries (comprehensive check)
    validate-boundaries-all:
      run: |
        echo "üîç Validating all client/server boundaries..."
        pnpm validate:boundaries
      fail_text: "‚ùå Client/server boundary validation failed. Fix errors before pushing."

    # 7. Validate server actions (comprehensive check)
    validate-server-actions-all:
      run: |
        echo "üîç Validating all server actions..."
        pnpm validate:server-actions
      fail_text: "‚ùå Server action validation failed. Fix errors before pushing."

    # 8. Validate database queries (comprehensive check)
    validate-database-queries-all:
      run: |
        echo "üîç Validating all database queries..."
        pnpm validate:database-queries
      fail_text: "‚ùå Database query validation failed. Fix errors before pushing."

    # 9. Validate authentication checks (comprehensive check)
    validate-authentication-all:
      run: |
        echo "üîç Validating all authentication checks..."
        pnpm validate:authentication
      fail_text: "‚ùå Authentication validation failed. Fix errors before pushing."

    # 10. Validate RLS policies (comprehensive check)
    validate-rls-policies-all:
      run: |
        echo "üîç Validating all RLS policies..."
        pnpm validate:rls-policies
      fail_text: "‚ùå RLS policy validation failed. Fix errors before pushing."

    # 11. Validate Cache Components (comprehensive check)
    validate-cache-components-all:
      run: |
        echo "üîç Validating all Cache Components usage..."
        pnpm validate:cache-components
      fail_text: "‚ùå Cache Components validation failed. Fix errors before pushing."

    # 12. Validate NextResponse promises (comprehensive check)
    validate-nextresponse-promises-all:
      run: |
        echo "üîç Validating all NextResponse promise handling..."
        pnpm validate:nextresponse-promises
      fail_text: "‚ùå NextResponse promise validation failed. Fix errors before pushing."

    # 13. Validate server component error handling (comprehensive check)
    validate-server-component-errors-all:
      run: |
        echo "üîç Validating all server component error handling..."
        pnpm validate:server-component-errors
      fail_text: "‚ùå Server component error handling validation failed. Fix errors before pushing."

    # 14. Validate client component error handling (comprehensive check)
    validate-client-component-errors-all:
      run: |
        echo "üîç Validating all client component error handling..."
        pnpm validate:client-component-errors
      fail_text: "‚ùå Client component error handling validation failed. Fix errors before pushing."

    # 15. Validate logging context (comprehensive check)
    validate-logging-context-all:
      run: |
        echo "üîç Validating all logging context and request ID usage..."
        pnpm validate:logging-context
      fail_text: "‚ùå Logging context validation failed. Fix errors before pushing."

    # 4. Production build verification (graceful)
    build:
      run: |
        echo "üèóÔ∏è  Verifying production build..."
        if [ -z "$SUPABASE_URL" ] || [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then
          echo "‚ö†Ô∏è  Supabase env vars not set - skipping build verification"
          echo "   (CI will verify build with proper environment variables)"
          echo ""
          echo "   To run build locally, ensure these are set:"
          echo "   - SUPABASE_URL"
          echo "   - NEXT_PUBLIC_SUPABASE_URL"
          echo "   - SUPABASE_ANON_KEY"
          exit 0
        fi
        pnpm build
      fail_text: "‚ùå Build failed. Fix errors before pushing."

    # 4. Run full test suite (non-blocking, warnings only)
    test-all:
      run: |
        echo "üß™ Running full test suite (non-blocking)..."
        set +e
        pnpm test --run 2>&1
        TEST_STATUS=$?
        if [ $TEST_STATUS -ne 0 ]; then
          echo "‚ö†Ô∏è  Some tests failed (not blocking - fix before merging)"
          echo "   Run 'pnpm test' to see full output"
        else
          echo "‚úÖ All tests passed"
        fi
        exit 0
      fail_text: "‚ö†Ô∏è  Tests failed (not blocking - fix before merging)."

    # 5. Technical debt analysis (non-blocking warnings)
    tech-debt:
      run: |
        echo "üìä Analyzing technical debt..."
        echo ""

        # Check for unused exports (knip)
        echo "üîç Checking for unused exports..."
        if command -v npx &> /dev/null; then
          UNUSED=$(npx knip -c config/tools/knip.json --no-exit-code 2>/dev/null | grep -E "Unused (exports|types|dependencies)" | head -10 || true)
          if [ -n "$UNUSED" ]; then
            echo "$UNUSED"
            echo "   ... (run 'pnpm analyze:unused' for full report)"
          else
            echo "   ‚úÖ No unused exports detected"
          fi
        else
          echo "   ‚ö†Ô∏è  npx not available - skipping"
        fi

        echo ""

        # Check for circular dependencies
        echo "üîÑ Checking for circular dependencies..."
          CIRCULAR=$(npx madge --circular --extensions ts,tsx apps/web/src/ 2>/dev/null || true)
        if [ -n "$CIRCULAR" ]; then
          echo "$CIRCULAR" | head -10
          echo "   ... (run 'pnpm analyze:circular' for full report)"
        else
          echo "   ‚úÖ No circular dependencies detected"
        fi

        echo ""

        # Check for large files (>500 lines)
        echo "üìè Checking for large files (>500 LOC)..."
          LARGE_FILES=$(find apps/web/src apps/edge/functions -name '*.ts' -o -name '*.tsx' 2>/dev/null | while read file; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            if [ "$lines" -gt 500 ]; then
              echo "   ‚ö†Ô∏è  $file ($lines lines) - consider splitting"
            fi
          fi
        done)

        if [ -n "$LARGE_FILES" ]; then
          echo "$LARGE_FILES" | head -10
        else
          echo "   ‚úÖ No large files detected"
        fi

        echo ""
        echo "‚úÖ Tech debt analysis complete (warnings only - not blocking)"
      fail_text: "‚ÑπÔ∏è  Technical debt detected (not blocking - address iteratively)."

# ============================================================================
# COMMIT-MSG: Enforce conventional commits (with WIP support)
# ============================================================================
commit-msg:
  commands:
    conventional-commits:
      run: |
        MSG=$(cat {1})

        # Skip merge commits
        if echo "$MSG" | grep -qE "^Merge (branch|pull request)"; then
          exit 0
        fi

        # Skip fixup/squash commits
        if echo "$MSG" | grep -qE "^(fixup|squash)!"; then
          exit 0
        fi

        # Allow WIP commits with reduced validation
        if echo "$MSG" | grep -qE "^wip"; then
          echo "‚ÑπÔ∏è  WIP commit detected - reduced validation"
          echo "   Remember to use proper conventional commit format when squashing/rebasing"
          exit 0
        fi

        # Validate conventional commit format
        if ! echo "$MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}"; then
          echo "‚ö†Ô∏è  Commit message doesn't follow Conventional Commits format"
          echo ""
          echo "Format: type(scope): description"
          echo "Types: feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"
          echo ""
          echo "Examples:"
          echo "  feat(auth): add Google OAuth"
          echo "  fix(api): resolve race condition"
          echo "  wip: experimenting with new feature (skips validation)"
          echo ""
          echo "üí° Tip: Set LEFTHOOK_EXCLUDE=commit-msg to skip this check"
          exit 1
        fi

# ============================================================================
# POST-MERGE: Auto-install dependencies when package.json changes
# ============================================================================
post-merge:
  piped: true
  commands:
    deps-install:
      files: git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD
      glob: "{package.json,pnpm-lock.yaml}"
      run: |
        echo "üì¶ Dependencies changed. Installing updates..."
        pnpm install
      fail_text: "‚ö†Ô∏è  Dependency installation failed. Run 'pnpm install' manually."

# ============================================================================
# CONFIGURATION
# ============================================================================
colors: true
no_tty: false
min_version: 1.13.0

# ============================================================================
# USAGE TIPS
# ============================================================================
# Skip specific commands:
#   LEFTHOOK_EXCLUDE=type-check,lint git commit
#   LEFTHOOK_EXCLUDE=tech-debt git push
#
# Skip commit-msg validation:
#   LEFTHOOK_EXCLUDE=commit-msg git commit
#
# Skip build verification (when env vars missing):
#   LEFTHOOK_EXCLUDE=build git push
#
# Use WIP commits for rapid iteration:
#   git commit -m "wip: testing new approach"
#
# Verbose debugging:
#   LEFTHOOK_VERBOSE=1 git commit
#
# Skip all hooks (use sparingly):
#   git commit --no-verify
#   git push --no-verify
#
# Technical debt reports:
#   pnpm analyze:unused    # Full unused exports report
#   pnpm analyze:circular  # Full circular dependency report
# ============================================================================

# Lefthook Configuration - Claude Pro Directory
# Version: 4.0.0 (Optimized - December 2025)
# Optimized for large codebase: Reduced from 18‚Üí5 pre-commit groups, 15‚Üí4 pre-push commands

# ============================================================================
# OUTPUT CONTROL
# ============================================================================
output:
  - execution      # Show what's running
  - execution_out  # Show command output
  - skips         # Show skipped commands
  - failure       # Always show failures

# ============================================================================
# PRE-COMMIT: Fast, parallel, smart grouping
# Reduced from 18 commands to 5 logical groups for better performance
# ============================================================================
pre-commit:
  parallel: true
  follow: true
  commands:
    # GROUP 1: Critical blocking checks (must pass, fail fast)
    critical:
      glob: "**/*.{ts,tsx}"
      exclude: 
        - "apps/edge/functions/**"
        - "packages/edge-runtime/src/utils/email/**"
      run: |
        echo "üö® Running critical checks..."
        START=$(date +%s%N)
        
        # Type check (exits if fails)
        pnpm type-check:build || exit 1
        
        # Architecture validations (exits if fails)
        pnpm validate:boundaries || exit 1
        pnpm validate:api-routes || exit 1
        pnpm validate:server-actions || exit 1
        
        # Client/server boundaries (exits if fails)
        pnpm validate:client-server || exit 1
        
        # Database validations (exits if fails)
        pnpm validate:database-queries || exit 1
        pnpm validate:authentication || exit 1
        
        # RLS policies (exits if fails)
        pnpm validate:rls-policies || exit 1
        
        # Performance validations (exits if fails)
        pnpm validate:cache-components || exit 1
        pnpm validate:nextresponse-promises || exit 1
        
        # Error handling validations (exits if fails)
        pnpm validate:server-component-errors || exit 1
        pnpm validate:client-component-errors || exit 1
        
        # Observability (exits if fails)
        pnpm validate:logging-context || exit 1
        
        DURATION=$(( ($(date +%s%N) - START) / 1000000 ))
        echo "‚úÖ Critical checks passed (${DURATION}ms)"
      fail_text: "‚ùå Critical validation failed. Fix before committing."

    # GROUP 2: Edge functions (isolated, parallel with GROUP 1)
    edge:
      glob: "apps/edge/functions/**/*.ts"
      run: |
        echo "ü¶ï Checking edge functions..."
        if command -v deno &> /dev/null; then
          set +e
          OUTPUT=$(pnpm type-check:edge 2>&1)
          STATUS=$?
          echo "$OUTPUT"
          if [ $STATUS -ne 0 ]; then
            if echo "$OUTPUT" | grep -F "packages/edge-runtime/src/utils/email/" >/dev/null; then
              echo "‚ö†Ô∏è  Email template type errors ignored (packages/edge-runtime/src/utils/email/**)"
              exit 0
            fi
            exit $STATUS
          fi
        else
          echo "‚ö†Ô∏è  Deno not installed - skipping edge function type-check"
          echo "   Install: brew install deno"
          exit 0
        fi
      fail_text: "‚ùå Edge function validation failed."

    # GROUP 3: Schema validation (runs in parallel with GROUP 1 & 2)
    schemas:
      glob: "apps/edge/supabase/functions/heyclaude-mcp/**/*.ts"
      run: |
        echo "üìã Validating schemas..."
        set +e
        pnpm validate:zod-schemas 2>&1 | tail -5
        pnpm validate:mcp-tools 2>&1 | tail -5
        exit 0
      fail_text: "‚ö†Ô∏è  Schema validation issues (review before merging)."

    # GROUP 4: Auto-fixable issues (non-blocking, fixes staged files)
    auto-fix:
      glob: "**/*.{ts,tsx}"
      exclude: 
        - "apps/edge/functions/**"
        - "packages/edge-runtime/src/utils/email/**"
      run: |
        echo "üîß Auto-fixing code..."
        set +e
        pnpm lint:build --fix 2>&1 | tail -3
        git add -u
        exit 0
      stage_fixed: true

    # GROUP 5: Tests (non-blocking, runs in parallel)
    tests:
      glob: "**/*.{ts,tsx}"
      exclude: 
        - "apps/edge/functions/**"
        - "packages/edge-runtime/src/utils/email/**"
      run: |
        echo "üß™ Running affected tests..."
        set +e
        pnpm test --run --changed 2>&1 | tail -15
        exit 0
      fail_text: "‚ö†Ô∏è  Tests failed (non-blocking - fix before merging)."

# ============================================================================
# PRE-PUSH: Comprehensive but optimized
# Reduced from 15 commands to 4 consolidated commands
# ============================================================================
pre-push:
  parallel: false
  commands:
    # Comprehensive validation (all critical checks in one command)
    validate:
      run: |
        echo "üîç Running comprehensive validation..."
        START=$(date +%s%N)
        
        echo "  ‚ñ∂Ô∏è  Type checking..."
        pnpm type-check:build || exit 1
        
        echo "  ‚ñ∂Ô∏è  Architecture..."
        pnpm validate:boundaries || exit 1
        pnpm validate:api-routes || exit 1
        pnpm validate:server-actions || exit 1
        pnpm validate:client-server || exit 1
        
        echo "  ‚ñ∂Ô∏è  Data layer..."
        pnpm validate:database-queries || exit 1
        pnpm validate:authentication || exit 1
        pnpm validate:rls-policies || exit 1
        
        echo "  ‚ñ∂Ô∏è  Performance..."
        pnpm validate:cache-components || exit 1
        pnpm validate:nextresponse-promises || exit 1
        
        echo "  ‚ñ∂Ô∏è  Error handling..."
        pnpm validate:server-component-errors || exit 1
        pnpm validate:client-component-errors || exit 1
        
        echo "  ‚ñ∂Ô∏è  Observability..."
        pnpm validate:logging-context || exit 1
        
        echo "  ‚ñ∂Ô∏è  MCP tools..."
        pnpm validate:mcp || exit 1
        
        DURATION=$(( ($(date +%s%N) - START) / 1000000 ))
        echo "‚úÖ Validation passed (${DURATION}ms)"
      fail_text: "‚ùå Validation failed. Fix before pushing."

    # Build verification (with better env var handling)
    build:
      run: |
        echo "üèóÔ∏è  Verifying build..."
        START=$(date +%s%N)
        
        # Check for missing env vars
        MISSING_VARS=()
        for var in SUPABASE_URL NEXT_PUBLIC_SUPABASE_URL SUPABASE_ANON_KEY; do
          if [ -z "$(eval echo \$$var)" ]; then
            MISSING_VARS+=("$var")
          fi
        done
        
        if [ ${#MISSING_VARS[@]} -gt 0 ]; then
          echo "‚ö†Ô∏è  Missing env vars: ${MISSING_VARS[*]}"
          echo "   Loading from .env.local..."
          
          if [ -f ".env.local" ]; then
            set -a && source .env.local && set +a
            echo "   ‚úÖ Loaded .env.local"
          else
            echo "   ‚ö†Ô∏è  .env.local not found - build verification skipped"
            echo "   (CI will verify with proper environment)"
            exit 0
          fi
        fi
        
        pnpm build || exit 1
        
        DURATION=$(( ($(date +%s%N) - START) / 1000000 ))
        echo "‚úÖ Build verified (${DURATION}ms)"
      fail_text: "‚ùå Build failed."

    # Tests (non-blocking)
    tests:
      run: |
        echo "üß™ Running tests..."
        set +e
        pnpm test --run 2>&1 | tail -20
        exit 0
      fail_text: "‚ö†Ô∏è  Tests failed (non-blocking)."

    # Tech debt (non-blocking, fast snapshot)
    tech-debt:
      run: |
        echo "üìä Tech debt snapshot..."
        echo ""
        
        # Unused exports (quick check)
        echo "üîç Checking unused exports..."
        UNUSED_COUNT=$(npx knip -c config/tools/knip.json --no-exit-code 2>/dev/null | grep -c "Unused " || echo 0)
        if [ "$UNUSED_COUNT" -gt 0 ]; then
          echo "   ‚ö†Ô∏è  Found $UNUSED_COUNT unused items"
          echo "   Run: pnpm analyze:unused"
        else
          echo "   ‚úÖ No unused exports"
        fi
        
        # Circular deps (quick check)
        echo "üîÑ Checking circular dependencies..."
        CIRCULAR_COUNT=$(npx madge --circular --extensions ts,tsx apps/web/src 2>/dev/null | grep -c "‚Üª" || echo 0)
        if [ "$CIRCULAR_COUNT" -gt 0 ]; then
          echo "   ‚ö†Ô∏è  Found circular dependencies"
          echo "   Run: pnpm analyze:circular"
        else
          echo "   ‚úÖ No circular dependencies"
        fi
        
        # Large files (quick check)
        echo "üìè Checking for bloat..."
        LARGE_FILES=$(find apps/web/src apps/edge/functions -name "*.ts" -o -name "*.tsx" 2>/dev/null | xargs wc -l 2>/dev/null | awk '$1 > 500 {print $2}' | wc -l)
        if [ "$LARGE_FILES" -gt 0 ]; then
          echo "   ‚ö†Ô∏è  Found $LARGE_FILES files > 500 LOC"
          echo "   Run: pnpm analyze:files"
        else
          echo "   ‚úÖ No bloated files"
        fi
        
        echo ""
        echo "‚úÖ Tech debt check complete (non-blocking)"
        exit 0
      fail_text: "‚ÑπÔ∏è  Tech debt detected."

# ============================================================================
# COMMIT-MSG: Enforce conventional commits (with WIP support)
# ============================================================================
commit-msg:
  commands:
    conventional:
      run: |
        MSG=$(cat {1})
        
        # Skip merge commits
        if echo "$MSG" | grep -qE "^Merge (branch|pull request)"; then
          exit 0
        fi
        
        # Skip fixup/squash commits
        if echo "$MSG" | grep -qE "^(fixup|squash)!"; then
          exit 0
        fi
        
        # Allow WIP commits with reduced validation
        if echo "$MSG" | grep -qE "^wip"; then
          echo "‚ÑπÔ∏è  WIP commit detected - reduced validation"
          echo "   Remember to use proper conventional commit format when squashing/rebasing"
          exit 0
        fi
        
        # Validate conventional commit format
        if ! echo "$MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}"; then
          echo "‚ö†Ô∏è  Commit message doesn't follow Conventional Commits format"
          echo ""
          echo "Format: type(scope): description"
          echo "Types: feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"
          echo ""
          echo "Examples:"
          echo "  feat(auth): add Google OAuth"
          echo "  fix(api): resolve race condition"
          echo "  wip: experimenting with new feature (skips validation)"
          echo ""
          echo "üí° Tip: Set LEFTHOOK_EXCLUDE=commit-msg to skip this check"
          exit 1
        fi

# ============================================================================
# POST-MERGE: Auto-install dependencies when package.json changes
# ============================================================================
post-merge:
  piped: true
  commands:
    deps:
      files: git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD
      glob: "{package.json,pnpm-lock.yaml}"
      run: |
        echo "üì¶ Dependencies changed. Installing updates..."
        pnpm install
      fail_text: "‚ö†Ô∏è  Dependency installation failed. Run 'pnpm install' manually."

# ============================================================================
# CONFIGURATION
# ============================================================================
colors: true
no_tty: false
min_version: 1.13.0

# ============================================================================
# USAGE TIPS
# ============================================================================
# Skip specific commands:
#   LEFTHOOK_EXCLUDE=critical,edge git commit
#   LEFTHOOK_EXCLUDE=tech-debt git push
#
# Skip commit-msg validation:
#   LEFTHOOK_EXCLUDE=commit-msg git commit
#
# Skip build verification (when env vars missing):
#   LEFTHOOK_EXCLUDE=build git push
#
# Use WIP commits for rapid iteration:
#   git commit -m "wip: testing new approach"
#
# Verbose debugging:
#   LEFTHOOK_VERBOSE=1 git commit
#
# Skip all hooks (use sparingly):
#   git commit --no-verify
#   git push --no-verify
#
# Technical debt reports:
#   pnpm analyze:unused    # Full unused exports report
#   pnpm analyze:circular  # Full circular dependency report
# ============================================================================

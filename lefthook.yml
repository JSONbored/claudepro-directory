# Lefthook Configuration - Claude Pro Directory
# Version: 2.0.2 (November 2025)
# Database-first architecture: No JSON content validation needed

# ============================================================================
# OUTPUT CONTROL
# ============================================================================
output:
  - execution      # Show what's running
  - execution_out  # Show command output
  - skips         # Show skipped commands
  - failure       # Always show failures

# ============================================================================
# PRE-COMMIT: Fast checks on staged files only
# Runs in parallel for speed, fails fast on critical issues
# ============================================================================
pre-commit:
  parallel: true
  follow: true
  commands:
    # 1. Type checking for TypeScript files
    type-check:
      glob: "**/*.{ts,tsx}"
      run: |
        echo "üîç Type checking..."
        pnpm type-check
      fail_text: "‚ùå Type errors found. Fix them before committing."

    # 2. Format check (Biome)
    format-check:
      glob: "**/*.{ts,tsx,js,jsx,json}"
      run: |
        echo "‚ú® Checking code formatting..."
        pnpm lint || (echo "‚ùå Run 'pnpm format' to auto-fix formatting issues" && exit 1)
      fail_text: "‚ùå Formatting issues found. Run 'pnpm format' to fix."

# ============================================================================
# PRE-PUSH: Comprehensive checks before code reaches remote
# ============================================================================
pre-push:
  parallel: false
  commands:
    # 1. Production build verification (CRITICAL - must pass)
    build:
      run: |
        echo "üèóÔ∏è  Verifying production build..."
        pnpm build
      fail_text: "‚ùå Build failed. Fix errors before pushing."

    # 2. Security audit (warnings only, not blocking)
    security:
      run: |
        echo "üîí Running security audit..."
        pnpm audit --audit-level=moderate --prod || true
      fail_text: "‚ö†Ô∏è  Security vulnerabilities found (not blocking)."

# ============================================================================
# COMMIT-MSG: Enforce conventional commits
# ============================================================================
commit-msg:
  commands:
    conventional-commits:
      run: |
        MSG=$(cat {1})

        # Skip merge commits
        if echo "$MSG" | grep -qE "^Merge (branch|pull request)"; then
          exit 0
        fi

        # Skip fixup/squash commits
        if echo "$MSG" | grep -qE "^(fixup|squash)!"; then
          exit 0
        fi

        # Validate conventional commit format
        if ! echo "$MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|wip)(\(.+\))?: .{1,}"; then
          echo "‚ö†Ô∏è  Commit message doesn't follow Conventional Commits format"
          echo ""
          echo "Format: type(scope): description"
          echo "Types: feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|wip"
          echo ""
          echo "Examples:"
          echo "  feat(auth): add Google OAuth"
          echo "  fix(api): resolve race condition"
          echo "  wip: experimenting with new feature"
          echo ""
          echo "üí° Tip: Set LEFTHOOK_EXCLUDE=commit-msg to skip this check"
          exit 1
        fi

# ============================================================================
# POST-MERGE: Auto-install dependencies when package.json changes
# ============================================================================
post-merge:
  piped: true
  commands:
    deps-install:
      files: git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD
      glob: "{package.json,pnpm-lock.yaml}"
      run: |
        echo "üì¶ Dependencies changed. Installing updates..."
        pnpm install
      fail_text: "‚ö†Ô∏è  Dependency installation failed. Run 'pnpm install' manually."

# ============================================================================
# CONFIGURATION
# ============================================================================
colors: true
no_tty: false
min_version: 1.13.0

# ============================================================================
# USAGE TIPS
# ============================================================================
# Skip specific commands:
#   LEFTHOOK_EXCLUDE=test-changed,type-check git commit
#
# Skip commit-msg validation:
#   LEFTHOOK_EXCLUDE=commit-msg git commit
#
# Verbose debugging:
#   LEFTHOOK_VERBOSE=1 git commit
#
# Skip all hooks (use sparingly):
#   git commit --no-verify
# ============================================================================

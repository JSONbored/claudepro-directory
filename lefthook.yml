# Lefthook Configuration - Claude Pro Directory
# Version: 3.0.0 (November 2025)
# Enhanced with auto-format, edge function type-check, and tech debt tracking

# ============================================================================
# OUTPUT CONTROL
# ============================================================================
output:
  - execution      # Show what's running
  - execution_out  # Show command output
  - skips         # Show skipped commands
  - failure       # Always show failures

# ============================================================================
# PRE-COMMIT: Fast checks on staged files only
# Runs in parallel for speed, fails fast on critical issues
# ============================================================================
pre-commit:
  parallel: true
  follow: true
  commands:
    # 1. Type checking (Next.js/Node code)
      type-check:
        glob: "**/*.{ts,tsx}"
        exclude: "apps/edge/functions/**"
      run: |
        echo "üîç Type checking Next.js code..."
        pnpm type-check
      fail_text: "‚ùå Type errors found in Next.js code. Fix them before committing."

    # 2. Type checking (Edge functions - Deno)
    type-check-edge:
      glob: "apps/edge/functions/**/*.ts"
      run: |
        echo "ü¶ï Type checking edge functions..."
        if command -v deno &> /dev/null; then
          pnpm type-check:edge
        else
          echo "‚ö†Ô∏è  Deno not installed - skipping edge function type-check"
          echo "   Install: brew install deno"
        fi
      fail_text: "‚ùå Type errors found in edge functions. Fix them before committing."

    # 3. Auto-format with Biome (via ultracite)
    format:
      glob: "**/*.{ts,tsx,js,jsx,json}"
      run: |
        echo "‚ú® Auto-formatting staged files..."
        npx ultracite fix
        git add -u
      fail_text: "‚ùå Auto-formatting failed. Check for syntax errors."

# ============================================================================
# PRE-PUSH: Comprehensive checks before code reaches remote
# ============================================================================
pre-push:
  parallel: false
  commands:
    # 1. Full type checking (Next.js/Node code only)
    # Note: Edge function type-checking runs in pre-commit hook (can be skipped via GitKraken UI)
    type-check-all:
      run: |
        echo "üîç Type checking Next.js/Node code..."
        pnpm type-check
      fail_text: "‚ùå Type errors found. Fix them before pushing."

    # 2. Production build verification (graceful)
    build:
      run: |
        echo "üèóÔ∏è  Verifying production build..."
        if [ -z "$SUPABASE_URL" ] || [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then
          echo "‚ö†Ô∏è  Supabase env vars not set - skipping build verification"
          echo "   (CI will verify build with proper environment variables)"
          echo ""
          echo "   To run build locally, ensure these are set:"
          echo "   - SUPABASE_URL"
          echo "   - NEXT_PUBLIC_SUPABASE_URL"
          echo "   - SUPABASE_ANON_KEY"
          exit 0
        fi
        pnpm build
      fail_text: "‚ùå Build failed. Fix errors before pushing."

    # 3. Technical debt analysis (non-blocking warnings)
    tech-debt:
      run: |
        echo "üìä Analyzing technical debt..."
        echo ""

        # Check for unused exports (knip)
        echo "üîç Checking for unused exports..."
        if command -v npx &> /dev/null; then
          UNUSED=$(npx knip -c config/tools/knip.json --no-exit-code 2>/dev/null | grep -E "Unused (exports|types|dependencies)" | head -10 || true)
          if [ -n "$UNUSED" ]; then
            echo "$UNUSED"
            echo "   ... (run 'pnpm analyze:unused' for full report)"
          else
            echo "   ‚úÖ No unused exports detected"
          fi
        else
          echo "   ‚ö†Ô∏è  npx not available - skipping"
        fi

        echo ""

        # Check for circular dependencies
        echo "üîÑ Checking for circular dependencies..."
          CIRCULAR=$(npx madge --circular --extensions ts,tsx apps/web/src/ 2>/dev/null || true)
        if [ -n "$CIRCULAR" ]; then
          echo "$CIRCULAR" | head -10
          echo "   ... (run 'pnpm analyze:circular' for full report)"
        else
          echo "   ‚úÖ No circular dependencies detected"
        fi

        echo ""

        # Check for large files (>500 lines)
        echo "üìè Checking for large files (>500 LOC)..."
          LARGE_FILES=$(find apps/web/src apps/edge/functions -name '*.ts' -o -name '*.tsx' 2>/dev/null | while read file; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            if [ "$lines" -gt 500 ]; then
              echo "   ‚ö†Ô∏è  $file ($lines lines) - consider splitting"
            fi
          fi
        done)

        if [ -n "$LARGE_FILES" ]; then
          echo "$LARGE_FILES" | head -10
        else
          echo "   ‚úÖ No large files detected"
        fi

        echo ""
        echo "‚úÖ Tech debt analysis complete (warnings only - not blocking)"
      fail_text: "‚ÑπÔ∏è  Technical debt detected (not blocking - address iteratively)."

# ============================================================================
# COMMIT-MSG: Enforce conventional commits (with WIP support)
# ============================================================================
commit-msg:
  commands:
    conventional-commits:
      run: |
        MSG=$(cat {1})

        # Skip merge commits
        if echo "$MSG" | grep -qE "^Merge (branch|pull request)"; then
          exit 0
        fi

        # Skip fixup/squash commits
        if echo "$MSG" | grep -qE "^(fixup|squash)!"; then
          exit 0
        fi

        # Allow WIP commits with reduced validation
        if echo "$MSG" | grep -qE "^wip"; then
          echo "‚ÑπÔ∏è  WIP commit detected - reduced validation"
          echo "   Remember to use proper conventional commit format when squashing/rebasing"
          exit 0
        fi

        # Validate conventional commit format
        if ! echo "$MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}"; then
          echo "‚ö†Ô∏è  Commit message doesn't follow Conventional Commits format"
          echo ""
          echo "Format: type(scope): description"
          echo "Types: feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"
          echo ""
          echo "Examples:"
          echo "  feat(auth): add Google OAuth"
          echo "  fix(api): resolve race condition"
          echo "  wip: experimenting with new feature (skips validation)"
          echo ""
          echo "üí° Tip: Set LEFTHOOK_EXCLUDE=commit-msg to skip this check"
          exit 1
        fi

# ============================================================================
# POST-MERGE: Auto-install dependencies when package.json changes
# ============================================================================
post-merge:
  piped: true
  commands:
    deps-install:
      files: git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD
      glob: "{package.json,pnpm-lock.yaml}"
      run: |
        echo "üì¶ Dependencies changed. Installing updates..."
        pnpm install
      fail_text: "‚ö†Ô∏è  Dependency installation failed. Run 'pnpm install' manually."

# ============================================================================
# CONFIGURATION
# ============================================================================
colors: true
no_tty: false
min_version: 1.13.0

# ============================================================================
# USAGE TIPS
# ============================================================================
# Skip specific commands:
#   LEFTHOOK_EXCLUDE=type-check,format git commit
#   LEFTHOOK_EXCLUDE=tech-debt git push
#
# Skip commit-msg validation:
#   LEFTHOOK_EXCLUDE=commit-msg git commit
#
# Skip build verification (when env vars missing):
#   LEFTHOOK_EXCLUDE=build git push
#
# Use WIP commits for rapid iteration:
#   git commit -m "wip: testing new approach"
#
# Verbose debugging:
#   LEFTHOOK_VERBOSE=1 git commit
#
# Skip all hooks (use sparingly):
#   git commit --no-verify
#   git push --no-verify
#
# Technical debt reports:
#   pnpm analyze:unused    # Full unused exports report
#   pnpm analyze:circular  # Full circular dependency report
# ============================================================================
